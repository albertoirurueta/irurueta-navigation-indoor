<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Utils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">com.irurueta:irurueta-navigation-indoor</a> &gt; <a href="index.source.html" class="el_package">com.irurueta.navigation.indoor</a> &gt; <span class="el_source">Utils.java</span></div><h1>Utils.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2018 Alberto Irurueta Carro (alberto@irurueta.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.irurueta.navigation.indoor;

import com.irurueta.algebra.AlgebraException;
import com.irurueta.algebra.Matrix;
import com.irurueta.geometry.Point2D;
import com.irurueta.geometry.Point3D;
import com.irurueta.navigation.indoor.radiosource.RssiRadioSourceEstimator;
import com.irurueta.numerical.EvaluationException;
import com.irurueta.numerical.JacobianEstimator;
import com.irurueta.numerical.MultiVariateFunctionEvaluatorListener;
import com.irurueta.statistics.MultivariateNormalDist;
import com.irurueta.statistics.StatisticsException;

@SuppressWarnings(&quot;Duplicates&quot;)
public class Utils {

    /**
     * Speed of light expressed in meters per second (m/s).
     */
    public static final double SPEED_OF_LIGHT = RssiRadioSourceEstimator.SPEED_OF_LIGHT;

    /**
     * Prevents instantiation
     */
    private Utils() {
    }

    /**
     * Converts from dBm's to linear power value expressed in mW.
     *
     * @param dBm value to be converted expressed in dBm's.
     * @return converted value expressed in mW.
     */
    public static double dBmToPower(final double dBm) {
<span class="fc" id="L50">        return Math.pow(10.0, dBm / 10.0);</span>
    }

    /**
     * Converts from mW to logarithmic power value expressed in dBm's.
     *
     * @param mW value to be converted expressed in mW's.
     * @return converted value expressed in dBm's.
     */
    public static double powerTodBm(final double mW) {
<span class="fc" id="L60">        return 10.0 * Math.log10(mW);</span>
    }

    /**
     * Propagates variance on received power measure into distance variance by considering the following formula
     * for received power (expressed in dBm's):
     * rxPower = pathLossExponent * kdB + txPower - 5.0 * pathLossExponent * logSqrDistance,
     * where logSqrDistance is the logarithm in base 10 of the squared distance logSqrDistance = Math.log(d^2).
     * Taking into account the previous formula, distance can be expressed as:
     * d = 10.0^((pathLossExponent * kdB + txPower - rxPower)/(10.0 * pathLossExponent))
     * where kdB is a constant having the following expression:
     * kdB = 10.0 * log(c / (4 * pi * f)),
     * where c is the speed of light and f is the frequency.
     *
     * @param txPower          transmitted power expressed in dBm's.
     * @param rxPower          received power expressed in dBm's.
     * @param pathLossExponent path loss exponent.
     * @param frequency        frequency expressed in Hz.
     * @param rxPowerVariance  received power variance.
     * @return distance variance.
     */
    public static double propagatePowerVarianceToDistanceVariance(
            final double txPower, final double rxPower, final double pathLossExponent, final double frequency,
            final Double rxPowerVariance) {
<span class="fc bfc" id="L84" title="All 2 branches covered.">        if (rxPowerVariance == null) {</span>
<span class="fc" id="L85">            return 0.0;</span>
        }

<span class="fc" id="L88">        final var k = SPEED_OF_LIGHT / (4.0 * Math.PI * frequency);</span>
<span class="fc" id="L89">        final var kdB = 10.0 * Math.log10(k);</span>

        // distance follows the following expression:
        // d = 10.0^((pathLossExponent * kdB + txPower - rxPower)/(10.0 * pathLossExponent))
        // where kdB is a constant having the following expression:
        // kdB = 10.0 * log(c / (4 * pi * f)),
        // where c is the speed of light and f is the frequency.

        // hence, if the only unknown is the received power (x = rxPower), we can express the distance as:
        // d = f(x) = 10.0^((pathLossExponent * kdB + txPower - x)/(10.0 * pathLossExponent))

        // if we know the variance of received power var(x), then the variance of the distance will be:
        // var(d) = var(f(x)) = (f'(E(x)))^2*var(x)
        // where f'(x) is the derivative of f(x) evaluated at E(x) = rxPower

        // the derivative f'(x) has the following expression:
        // f'(x) = -ln(10)/(10.0*pathLossExponent)*10^((pathLossExponent * kdB + txPower - x)/(10.0 * pathLossExponent))

        // evaluate derivative at E(x) = rxPower:
<span class="fc" id="L108">        final var tenPathLossExponent = 10.0 * pathLossExponent;</span>
<span class="fc" id="L109">        final var derivativeF = -Math.log(10.0) / tenPathLossExponent * Math.pow(10.0,</span>
                (pathLossExponent * kdB + txPower - rxPower) / tenPathLossExponent);

<span class="fc" id="L112">        return derivativeF * derivativeF * rxPowerVariance;</span>
    }

    /**
     * Propagates provided variances (transmitted power variance, received power variance and path-loss variance) into
     * distance variance by considering the following formula for received power (expressed in dBm's):
     * rxPower = pathLossExponent * kdB + txPower - 5.0 * pathLossExponent * logSqrDistance,
     * where logSqrDistance is the logarithm in base 10 of the squared distance logSqrDistance = Math.log(d^2).
     * Taking into account the previous formula, distance can be expressed as:
     * d = 10.0^((pathLossExponent * kdB + txPower - rxPower)/(10.0 * pathLossExponent))
     * where kdB is a constant having the following expression:
     * kdB = 10.0 * log(c / (4 * pi * f)),
     * where c is the speed of light and f is the frequency.
     *
     * @param txPower                  transmitted power expressed in dBm's.
     * @param rxPower                  received power expressed in dBm's.
     * @param pathLossExponent         path loss exponent.
     * @param frequency                frequency expressed in Hz.
     * @param txPowerVariance          transmitted power variance.
     * @param rxPowerVariance          received power variance.
     * @param pathLossExponentVariance path loss exponent variance.
     * @return a normal distribution containing both expected distance and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToDistanceVariance(
            final double txPower, final double rxPower, final double pathLossExponent, final double frequency,
            final Double txPowerVariance, final Double rxPowerVariance, final Double pathLossExponentVariance)
            throws IndoorException {
<span class="pc bpc" id="L140" title="2 of 6 branches missed.">        if (txPowerVariance == null &amp;&amp; rxPowerVariance == null &amp;&amp; pathLossExponentVariance == null) {</span>
<span class="fc" id="L141">            return null;</span>
        }

<span class="fc" id="L144">        final var mean = new double[]{txPower, rxPower, pathLossExponent};</span>
<span class="fc" id="L145">        final var covariance = Matrix.diagonal(new double[]{</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">                txPowerVariance != null ? txPowerVariance : 0.0,</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">                rxPowerVariance != null ? rxPowerVariance : 0.0,</span>
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0</span>
        });

        try {
<span class="fc" id="L152">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(final double[] x, final double[] y, final Matrix jacobian) {
<span class="fc" id="L155">                    final var k = RssiRadioSourceEstimator.SPEED_OF_LIGHT / (4.0 * Math.PI * frequency);</span>
<span class="fc" id="L156">                    final var kdB = 10.0 * Math.log10(k);</span>

                    // received power in dBm's follows the equation:
                    // rxPower = pathLossExponent * kdB + txPower - 5.0 * pathLossExponent * logSqrDistance

                    // hence, distance follows the following expression:
                    // d = 10.0^((pathLossExponent * kdB + txPower - rxPower)/(10.0 * pathLossExponent))
                    // where kdB is a constant having the following expression:
                    // kdB = 10.0 * log(c / (4 * pi * f)),
                    // where c is the speed of light and f is the frequency.

<span class="fc" id="L167">                    final var logSqrDistance = (pathLossExponent * kdB + txPower - rxPower)</span>
                            / (5.0 * pathLossExponent);

                    // where logSqrDistance = Math.log10(sqrDistance)
                    // and sqrDistance = distance * distance, hence
                    // logSqrDistance = Math.log10(distance * distance) = 2 * Math.log10(distance)

<span class="fc" id="L174">                    y[0] = Math.pow(10.0, logSqrDistance / 2.0);</span>


                    // compute gradient (is a jacobian having 1 row and 3 columns)

                    // derivative of distance respect to transmitted power is:

                    // if the only unknown is the transmitted power (x = txPower), then:
                    // d = f(x) = 10.0^((pathLossExponent * kdB + x - rxPower)/(10.0 * pathLossExponent))
                    // and the derivative is
                    // f'(x) = ln(10)/(10.0 * pathLossExponent)*10.0^((pathLossExponent * kdB + x - rxPower)/(10.0 * pathLossExponent))
<span class="fc" id="L185">                    final var tenPathLossExponent = 10.0 * pathLossExponent;</span>
<span class="fc" id="L186">                    final var tenPowered = Math.pow(10.0, (pathLossExponent * kdB + txPower - rxPower)</span>
                            / tenPathLossExponent);
<span class="fc" id="L188">                    final var derivativeTxPower = Math.log(10.0) / tenPathLossExponent * tenPowered;</span>

                    // derivative of distance respect to received power is:

                    // if the only unknown is the received power (x = rxPower), then:
                    // d = f(x) = 10.0^((pathLossExponent * kdB + txPower - x)/(10.0 * pathLossExponent))
                    // and the derivative is
                    // f'(x) = -ln(10)/(10.0*pathLossExponent)*10^((pathLossExponent * kdB + txPower - x)/(10.0 * pathLossExponent))
<span class="fc" id="L196">                    final var derivativeRxPower = -Math.log(10.0) / tenPathLossExponent * tenPowered;</span>

                    // derivative respect to path loss exponent is:

                    // if the only unknown is the path loss exponent (x = pathLossExponent), then:
                    // d = f(x) = 10.0^((x * kdB + txPower - rxPower)/(10.0 * x))
                    // and the derivative is:
                    // f'(x) = ln(10) * g'(x) * 10.0^(g(x))
                    // where g(x) is:
                    // g(x) = (x * kdB + txPower - rxPower) / (10.0 * x)
                    // and the derivative of g(x) is:
                    // g'(x) = (kdB * 10.0 * x - 10.0 * (x * kdB + txPower - rxPower)) / (10.0 * x)^2
                    // Hence:
                    // f'(x) = lng(10) * (kdB * 10.0 * x - 10.0 * (x * kdB + txPower - rxPower)) / (10.0 * x)^2 * 10.0^((x * kdB + txPower - rxPower)/(10.0 * x))

<span class="fc" id="L211">                    final var g = (pathLossExponent * kdB + txPower - rxPower) / (10.0 * pathLossExponent);</span>
<span class="fc" id="L212">                    final var derivativeG = (kdB * 10.0 * pathLossExponent</span>
                            - 10.0 * (pathLossExponent * kdB + txPower - rxPower))
<span class="fc" id="L214">                            / Math.pow(10.0 * pathLossExponent, 2.0);</span>

<span class="fc" id="L216">                    final var derivativePathLossExponent = Math.log(10.0) * derivativeG * Math.pow(10.0, g);</span>

<span class="fc" id="L218">                    jacobian.setElementAtIndex(0, derivativeTxPower);</span>
<span class="fc" id="L219">                    jacobian.setElementAtIndex(1, derivativeRxPower);</span>
<span class="fc" id="L220">                    jacobian.setElementAtIndex(2, derivativePathLossExponent);</span>
<span class="fc" id="L221">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L225">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L228">        } catch (final AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L229">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (fingerprint rssi variance, path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * rssi variance by considering the 2D 1st order Taylor expression of received power.
     * Notice that any unknown variance is assumed to be zero.
     *
     * @param fingerprintRssi               closest located fingerprint reading RSSI expressed in dBm's.
     * @param pathLossExponent              path-loss exponent.
     * @param fingerprintPosition           position of closest fingerprint.
     * @param radioSourcePosition           radio source position associated to fingerprint reading.
     * @param estimatedPosition             position to be estimated. Usually this is equal to the
     *                                      initial position used by a non-linear algorithm.
     * @param fingerprintRssiVariance       variance of fingerprint RSSI or null if unknown.
     * @param pathLossExponentVariance      variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance   covariance of position to be estimated or null
     *                                      if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiVarianceFirstOrderNonLinear2D(
            final double fingerprintRssi, final double pathLossExponent, final Point2D fingerprintPosition,
            final Point2D radioSourcePosition, final Point2D estimatedPosition, final Double fingerprintRssiVariance,
            final Double pathLossExponentVariance, final Matrix fingerprintPositionCovariance,
            final Matrix radioSourcePositionCovariance, final Matrix estimatedPositionCovariance)
            throws IndoorException {

<span class="fc bfc" id="L263" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null || estimatedPosition == null) {</span>
<span class="fc" id="L264">            return null;</span>
        }

        // 1st order Taylor expression of received power in 2D:
        // Pr(pi) = Pr(p1)
        //   - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
        //   - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
        // where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2

<span class="fc" id="L273">        final var x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L274">        final var y1 = fingerprintPosition.getInhomY();</span>

<span class="fc" id="L276">        final var xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L277">        final var ya = radioSourcePosition.getInhomY();</span>

<span class="fc" id="L279">        final var xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L280">        final var yi = estimatedPosition.getInhomY();</span>

<span class="fc" id="L282">        final var mean = new double[]{</span>
                fingerprintRssi, pathLossExponent, x1, y1, xa, ya, xi, yi
        };
<span class="fc" id="L285">        final var covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">                fingerprintRssiVariance != null ? fingerprintRssiVariance : 0.0,</span>
<span class="fc bfc" id="L287" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L291" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null</span>
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">                &amp;&amp; fingerprintPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">                &amp;&amp; fingerprintPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="fc" id="L295">            covariance.setSubmatrix(2, 2, 3, 3,</span>
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L299" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null</span>
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L302">            covariance.setSubmatrix(4, 4, 5, 5,</span>
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L306" title="All 2 branches covered.">        if (estimatedPositionCovariance != null</span>
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L308" title="1 of 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L309">            covariance.setSubmatrix(6, 6, 7, 7,</span>
                    estimatedPositionCovariance);
        }

        try {
<span class="fc" id="L314">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(final double[] x, final double[] y, final Matrix jacobian) {

                    // Pr(pi) = Pr(p1)
                    //   - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    //   - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
                    // where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2

                    // Hence:
                    // Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/
                    //       (ln(10)*((x1 - xa)^2 + (y1 - ya)^2))

<span class="fc" id="L327">                    final var diffX1a = x1 - xa;</span>
<span class="fc" id="L328">                    final var diffY1a = y1 - ya;</span>

<span class="fc" id="L330">                    final var diffXi1 = xi - x1;</span>
<span class="fc" id="L331">                    final var diffYi1 = yi - y1;</span>

<span class="fc" id="L333">                    final var diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L334">                    final var diffY1a2 = diffY1a * diffY1a;</span>

<span class="fc" id="L336">                    final var d1a2 = diffX1a2 + diffY1a2;</span>
<span class="fc" id="L337">                    final var d1a4 = d1a2 * d1a2;</span>

<span class="fc" id="L339">                    final var ln10 = Math.log(10.0);</span>
<span class="fc" id="L340">                    final var crossDiff = diffX1a * diffXi1 + diffY1a * diffYi1;</span>

<span class="fc" id="L342">                    y[0] = fingerprintRssi - 10.0 * pathLossExponent * crossDiff / (ln10 * d1a2);</span>

                    // compute gradient (is a jacobian having 1 row and 8 columns)

                    // derivative of rssi respect to fingerprint rssi
<span class="fc" id="L347">                    final var derivativeFingerprintRssi = 1.0;</span>

                    // derivative of rssi respect to path-loss exponent

                    // diff(Pr(pi))/diff(n) = -10*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    //   -10*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
<span class="fc" id="L353">                    final var derivativePathLossExponent = -10.0 * crossDiff / (ln10 * d1a2);</span>

                    // derivative of rssi respect to x1

                    // We have
                    // Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/
                    //       (ln(10)*((x1 - xa)^2 + (y1 - ya)^2))

                    // and we know that: (f(x)/g(x))' = (f'(x)*g(x) - f(x)*g'(x))/g(x)^2
                    // and also that (f(x)*g(x))' = f'(x)*g(x) + f(x)*g'(x)

                    // Hence
                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(x1) =
                    //   diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(x1) =
                    //   diff(-x1^2 + (xi + xa)*x1 - xa*xi)/diff(x1) =
                    //   -2*x1 + xi + xa

                    // diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    // diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(x1 - xa))/d1a^4
<span class="fc" id="L372">                    final var tmpX = 2.0 * crossDiff * diffX1a;</span>
<span class="fc" id="L373">                    final var derivativeX1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * x1 + xi + xa) * d1a2</span>
                            - tmpX) / d1a4;

                    // derivative of rssi respect to y1

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(y1) =
                    //   diff(y1*yi -ya*yi -y1^2 + ya*y1)/diff(y1) =
                    //   diff(-y1^2 + (yi + ya)*y1 - ya*yi)/diff(y1) =
                    //   -2*y1 + yi + ya

                    // diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    // diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(y1 - ya))/d1a^4
<span class="fc" id="L385">                    final var tmpY = 2.0 * crossDiff * diffY1a;</span>
<span class="fc" id="L386">                    final var derivativeY1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * y1 + yi + ya) * d1a2</span>
                            - tmpY) / d1a4;


                    // derivative of rssi respect to xa

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(xa) =
                    //   diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(xa) =
                    //   x1 - xi

                    // diff(Pr(pi))/diff(xa) = -10*n/ln(10)*((x1 - xi)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    // diff(Pr(pi))/diff(xa) = -10*n/ln(10)*(-(xi - x1)*d1a^2 + ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(x1 - xa))/d1a^4
<span class="fc" id="L398">                    final var derivativeXa = -10.0 * pathLossExponent / ln10 * (-diffXi1 * d1a2 + tmpX) / d1a4;</span>

                    // derivative of rssi respect to ya

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(ya) =
                    //   diff(y1*yi -y1^2 -ya*yi + ya*y1)/diff(ya) =
                    //   y1 - yi

                    // diff(Pr(pi))/diff(ya) = -10*n/ln(10)*((y1 - yi)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    // diff(Pr(pi))/diff(ya) = -10*n/ln(10)*(-(yi - y1)*d1a^2 + ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(y1 - ya))/d1a^4
<span class="fc" id="L408">                    final var derivativeYa = -10.0 * pathLossExponent / ln10 * (-diffYi1 * d1a2 + tmpY) / d1a4;</span>

                    // derivative of rssi respect to xi

                    // Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/
                    //       (ln(10)*((x1 - xa)^2 + (y1 - ya)^2))

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(xi) =
                    //   diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(xi) =
                    //   x1 - xa

                    // diff(Pr(pi))/diff(xi) = -10*n/ln(10)*((x1 - xa)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*0)/(x1 - xa)^2 + (y1 - ya)^2)^2
                    // diff(Pr(pi))/diff(xi) = -10*n/ln(10)*((x1 - xa)*d1a^2)/d1a^4
                    // diff(Pr(pi))/diff(xi) = -10*n*(x1 - xa)/(ln(10)*d1a^2)
<span class="fc" id="L422">                    final var derivativeXi = -10.0 * pathLossExponent * diffX1a / (ln10 * d1a2);</span>

                    // derivative of rssi respect to yi

                    // Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/
                    //       (ln(10)*((x1 - xa)^2 + (y1 - ya)^2))

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(yi) =
                    //   diff(y1*yi -ya*yi -y1^2 + ya*y1)/diff(yi) =
                    //   y1 - ya

                    // diff(Pr(pi))/diff(yi) = -10*n/ln(10)*((y1 - ya)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*0)/((x1 - xa)^2 + (y1 - ya)^2)^2
                    // diff(Pr(pi))/diff(yi) = -10*n/ln(10)*((y1 - ya)*d1a^2)/d1a^4
                    // diff(Pr(pi))/diff(yi) = -10*n*(y1 - ya)/(ln(10)*d1a^2)
<span class="fc" id="L436">                    final var derivativeYi = -10.0 * pathLossExponent * diffY1a / (ln10 * d1a2);</span>

                    // set derivatives fingerprintRssi, pathLossExponent, x1, y1, xa, ya, xi, yi
<span class="fc" id="L439">                    jacobian.setElementAtIndex(0, derivativeFingerprintRssi);</span>
<span class="fc" id="L440">                    jacobian.setElementAtIndex(1, derivativePathLossExponent);</span>
<span class="fc" id="L441">                    jacobian.setElementAtIndex(2, derivativeX1);</span>
<span class="fc" id="L442">                    jacobian.setElementAtIndex(3, derivativeY1);</span>
<span class="fc" id="L443">                    jacobian.setElementAtIndex(4, derivativeXa);</span>
<span class="fc" id="L444">                    jacobian.setElementAtIndex(5, derivativeYa);</span>
<span class="fc" id="L445">                    jacobian.setElementAtIndex(6, derivativeXi);</span>
<span class="fc" id="L446">                    jacobian.setElementAtIndex(7, derivativeYi);</span>
<span class="fc" id="L447">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L451">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L454">        } catch (final AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L455">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (fingerprint rssi variance, path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * rssi variance by considering the 3D 1st order Taylor expression of received power.
     * Notice that any unknown variance is assumed to be zero.
     *
     * @param fingerprintRssi               closest located fingerprint reading RSSI expressed in dBm's.
     * @param pathLossExponent              path-loss exponent.
     * @param fingerprintPosition           position of closest fingerprint.
     * @param radioSourcePosition           radio source position associated to fingerprint reading.
     * @param estimatedPosition             position to be estimated. Usually this is equal to the
     *                                      initial position used by a non-linear algorithm.
     * @param fingerprintRssiVariance       variance of fingerprint RSSI or null if unknown.
     * @param pathLossExponentVariance      variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance   covariance of position to be estimated or null
     *                                      if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiVarianceFirstOrderNonLinear3D(
            final double fingerprintRssi, final double pathLossExponent, final Point3D fingerprintPosition,
            final Point3D radioSourcePosition, final Point3D estimatedPosition, final Double fingerprintRssiVariance,
            final Double pathLossExponentVariance, final Matrix fingerprintPositionCovariance,
            final Matrix radioSourcePositionCovariance, final Matrix estimatedPositionCovariance)
            throws IndoorException {

<span class="fc bfc" id="L489" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null || estimatedPosition == null) {</span>
<span class="fc" id="L490">            return null;</span>
        }

        // 1st order Taylor expression of received power in 3D:
        // Pr(pi) = Pr(p1)
        //   - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
        //   - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
        //   - 10*n*(z1 - za)/(ln(10)*d1a^2)*(zi - z1)
        // where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2

<span class="fc" id="L500">        final var x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L501">        final var y1 = fingerprintPosition.getInhomY();</span>
<span class="fc" id="L502">        final var z1 = fingerprintPosition.getInhomZ();</span>

<span class="fc" id="L504">        final var xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L505">        final var ya = radioSourcePosition.getInhomY();</span>
<span class="fc" id="L506">        final var za = radioSourcePosition.getInhomZ();</span>

<span class="fc" id="L508">        final var xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L509">        final var yi = estimatedPosition.getInhomY();</span>
<span class="fc" id="L510">        final var zi = estimatedPosition.getInhomZ();</span>

<span class="fc" id="L512">        final var mean = new double[]{</span>
                fingerprintRssi, pathLossExponent, x1, y1, z1, xa, ya, za, xi, yi, zi
        };
<span class="fc" id="L515">        final var covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L516" title="All 2 branches covered.">                fingerprintRssiVariance != null ? fingerprintRssiVariance : 0.0,</span>
<span class="fc bfc" id="L517" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L521" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L522" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L523" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="fc" id="L525">            covariance.setSubmatrix(2, 2, 4, 4,</span>
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L529" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null</span>
<span class="pc bpc" id="L530" title="1 of 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L531" title="1 of 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L532">            covariance.setSubmatrix(5, 5, 7, 7,</span>
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L536" title="All 2 branches covered.">        if (estimatedPositionCovariance != null</span>
<span class="pc bpc" id="L537" title="1 of 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L538" title="1 of 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L539">            covariance.setSubmatrix(8, 8, 10, 10,</span>
                    estimatedPositionCovariance);
        }

        try {
<span class="fc" id="L544">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(final double[] x, final double[] y, final Matrix jacobian) {

                    // Pr(pi) = Pr(p1)
                    //   - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    //   - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
                    //   - 10*n*(z1 - za)/(ln(10)*d1a^2)*(zi - z1)
                    // where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2

                    // Hence:
                    // Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/
                    //       (ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

<span class="fc" id="L558">                    final var diffX1a = x1 - xa;</span>
<span class="fc" id="L559">                    final var diffY1a = y1 - ya;</span>
<span class="fc" id="L560">                    final var diffZ1a = z1 - za;</span>

<span class="fc" id="L562">                    final var diffXi1 = xi - x1;</span>
<span class="fc" id="L563">                    final var diffYi1 = yi - y1;</span>
<span class="fc" id="L564">                    final var diffZi1 = zi - z1;</span>

<span class="fc" id="L566">                    final var diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L567">                    final var diffY1a2 = diffY1a * diffY1a;</span>
<span class="fc" id="L568">                    final var diffZ1a2 = diffZ1a * diffZ1a;</span>

<span class="fc" id="L570">                    final var d1a2 = diffX1a2 + diffY1a2 + diffZ1a2;</span>
<span class="fc" id="L571">                    final var d1a4 = d1a2 * d1a2;</span>

<span class="fc" id="L573">                    final var ln10 = Math.log(10.0);</span>
<span class="fc" id="L574">                    final var crossDiff = diffX1a * diffXi1 + diffY1a * diffYi1 + diffZ1a * diffZi1;</span>

<span class="fc" id="L576">                    y[0] = fingerprintRssi - 10.0 * pathLossExponent * crossDiff / (ln10 * d1a2);</span>

                    // compute gradient (is a jacobian having 1 row and 11 columns)


                    // derivative of rssi respect to fingerprint rssi
<span class="fc" id="L582">                    final var derivativeFingerprintRssi = 1.0;</span>

                    // derivative of rssi respect to path-loss exponent

                    // diff(Pr(pi))/diff(n) = -10*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    //   -10*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
<span class="fc" id="L588">                    final var derivativePathLossExponent = -10.0 * crossDiff / (ln10 * d1a2);</span>

                    // derivative of rssi respect to x1

                    // We have
                    // Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/
                    //       (ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

                    // and we know that: (f(x)/g(x))' = (f'(x)*g(x) - f(x)*g'(x))/g(x)^2
                    // and also that (f(x)*g(x))' = f'(x)*g(x) + f(x)*g'(x)

                    // Hence
                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(x1) =
                    //   diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(x1) =
                    //   diff(-x1^2 + (xi + xa)*x1 - xa*xi)/diff(x1) =
                    //   -2*x1 + xi + xa

                    // diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    // diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(x1 - xa))/d1a^4
<span class="fc" id="L607">                    final var tmpX = 2.0 * crossDiff * diffX1a;</span>
<span class="fc" id="L608">                    final var derivativeX1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * x1 + xi + xa) * d1a2</span>
                            - tmpX) / d1a4;

                    // derivative of rssi respect to y1

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(y1) =
                    //   diff(y1*yi -ya*yi -y1^2 + ya*y1)/diff(y1) =
                    //   diff(-y1^2 + (yi + ya)*y1 - ya*yi)/diff(y1) =
                    //   -2*y1 + yi + ya

                    // diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    // diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(y1 - ya))/d1a^4
<span class="fc" id="L620">                    final var tmpY = 2.0 * crossDiff * diffY1a;</span>
<span class="fc" id="L621">                    final var derivativeY1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * y1 + yi + ya) * d1a2</span>
                            - tmpY) / d1a4;

                    // derivative of rssi respect to z1

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(z1) =
                    //   diff(z1*zi -za*zi -z1^2 + za*z1)/diff(z1) =
                    //   diff(-z1^2 + (zi + za)*z1 - za*zi)/diff(z1) =
                    //   -2*z1 + zi + za

                    // diff(Pr(pi))/diff(z1) = -10*n/ln(10)*((-2*z1 + zi + za)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    // diff(Pr(pi))/diff(z1) = -10*n/ln(10)*((-2*z1 + zi + za)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(z1 - za))/d1a^4
<span class="fc" id="L633">                    final var tmpZ = 2.0 * crossDiff * diffZ1a;</span>
<span class="fc" id="L634">                    final var derivativeZ1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * z1 + z1 + za) * d1a2</span>
                            - tmpZ) / d1a4;

                    // derivative of rssi respect to xa

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(xa) =
                    //   diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(xa) =
                    //   x1 - xi

                    // diff(Pr(pi))/diff(xa) = -10*n/ln(10)*((x1 - xi)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    // diff(Pr(pi))/diff(xa) = -10*n/ln(10)*(-(xi - x1)*d1a^2 + ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(x1 - xa))/d1a^4
<span class="fc" id="L645">                    final var derivativeXa = -10.0 * pathLossExponent / ln10 * (-diffXi1 * d1a2 + tmpX) / d1a4;</span>

                    // derivative of rssi respect to ya

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(ya) =
                    //   diff(y1*yi -y1^2 -ya*yi + ya*y1)/diff(ya) =
                    //   y1 - yi

                    // diff(Pr(pi))/diff(ya) = -10*n/ln(10)*((y1 - yi)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    // diff(Pr(pi))/diff(ya) = -10*n/ln(10)*(-(yi - y1)*d1a^2 + ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(y1 - ya))/d1a^4
<span class="fc" id="L655">                    final var derivativeYa = -10.0 * pathLossExponent / ln10 * (-diffYi1 * d1a2 + tmpY) / d1a4;</span>

                    // derivative of rssi respect to za

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(za) =
                    //   diff(z1*zi -z1^2 -za*zi + za*z1)/diff(za) =
                    //   z1 - zi

                    // diff(Pr(pi))/diff(za) = -10*n/ln(10)*((z1 - zi)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    // diff(Pr(pi))/diff(za) = -10*n/ln(10)*(-(zi - z1)*d1a^2 + ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(z1 - za))/d1a^4
<span class="fc" id="L665">                    final var derivativeZa = -10.0 * pathLossExponent / ln10 * (-diffZi1 * d1a2 + tmpZ) / d1a4;</span>

                    // derivative of rssi respect to xi

                    // Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/
                    //       (ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(xi) =
                    //   diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(xi) =
                    //   x1 - xa

                    // diff(Pr(pi))/diff(xi) = -10*n/ln(10)*((x1 - xa)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    // diff(Pr(pi))/diff(xi) = -10*n/ln(10)*((x1 - xa)*d1a^2)/d1a^4
                    // diff(Pr(pi))/diff(xi) = -10*n*(x1 - xa)/(ln(10)*d1a^2)
<span class="fc" id="L679">                    final var derivativeXi = -10.0 * pathLossExponent * diffX1a / (ln10 * d1a2);</span>

                    // derivative of rssi respect to yi

                    // Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/
                    //       (ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(yi) =
                    //   diff(y1*yi -ya*yi -y1^2 + ya*y1)/diff(yi) =
                    //   y1 - ya

                    // diff(Pr(pi))/diff(yi) = -10*n/ln(10)*((y1 - ya)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    // diff(Pr(pi))/diff(yi) = -10*n/ln(10)*((y1 - ya)*d1a^2)/d1a^4
                    // diff(Pr(pi))/diff(yi) = -10*n*(y1 - ya)/(ln(10)*d1a^2)
<span class="fc" id="L693">                    final var derivativeYi = -10.0 * pathLossExponent * diffY1a / (ln10 * d1a2);</span>

                    // derivative of rssi respect to zi

                    // Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/
                    //       (ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(zi) =
                    //   diff(z1*zi -za*zi -z1^2 + za*z1)/diff(zi) =
                    //   z1 - za

                    // diff(Pr(pi))/diff(zi) = -10*n/ln(10)*((z1 - za)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    // diff(Pr(pi))/diff(zi) = -10*n/ln(10)*((z1 - za)*d1a^2)/d1a^4
                    // diff(Pr(pi))/diff(zi) = -10*n*(z1 - za)/(ln(10*d1a^2)
<span class="fc" id="L707">                    final var derivativeZi = -10.0 * pathLossExponent * diffZ1a / (ln10 * d1a2);</span>

                    // set derivatives fingerprintRssi, pathLossExponent, x1, y1, z1, xa, ya, za, xi, yi, zi
<span class="fc" id="L710">                    jacobian.setElementAtIndex(0, derivativeFingerprintRssi);</span>
<span class="fc" id="L711">                    jacobian.setElementAtIndex(1, derivativePathLossExponent);</span>
<span class="fc" id="L712">                    jacobian.setElementAtIndex(2, derivativeX1);</span>
<span class="fc" id="L713">                    jacobian.setElementAtIndex(3, derivativeY1);</span>
<span class="fc" id="L714">                    jacobian.setElementAtIndex(4, derivativeZ1);</span>
<span class="fc" id="L715">                    jacobian.setElementAtIndex(5, derivativeXa);</span>
<span class="fc" id="L716">                    jacobian.setElementAtIndex(6, derivativeYa);</span>
<span class="fc" id="L717">                    jacobian.setElementAtIndex(7, derivativeZa);</span>
<span class="fc" id="L718">                    jacobian.setElementAtIndex(8, derivativeXi);</span>
<span class="fc" id="L719">                    jacobian.setElementAtIndex(9, derivativeYi);</span>
<span class="fc" id="L720">                    jacobian.setElementAtIndex(10, derivativeZi);</span>
<span class="fc" id="L721">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L725">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L728">        } catch (final AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L729">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (fingerprint rssi variance, path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * rssi variance by considering the 2D 2nd order Taylor expression of received power.
     * Notice that any unknown variance is assumed to be zero.
     *
     * @param fingerprintRssi               closest located fingerprint reading RSSI expressed in dBm's.
     * @param pathLossExponent              path-loss exponent.
     * @param fingerprintPosition           position of closest fingerprint.
     * @param radioSourcePosition           radio source position associated to fingerprint reading.
     * @param estimatedPosition             position to be estimated. Usually this is equal to the
     *                                      initial position used by a non-linear algorithm.
     * @param fingerprintRssiVariance       variance of fingerprint RSSI or null if unknown.
     * @param pathLossExponentVariance      variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance   covariance of position to be estimated or null
     *                                      if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiVarianceSecondOrderNonLinear2D(
            final double fingerprintRssi, final double pathLossExponent, final Point2D fingerprintPosition,
            final Point2D radioSourcePosition, final Point2D estimatedPosition, final Double fingerprintRssiVariance,
            final Double pathLossExponentVariance, final Matrix fingerprintPositionCovariance,
            final Matrix radioSourcePositionCovariance, final Matrix estimatedPositionCovariance)
            throws IndoorException {

<span class="fc bfc" id="L763" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null || estimatedPosition == null) {</span>
<span class="fc" id="L764">            return null;</span>
        }

        // 2nd order Taylor expression of received power in 2D:
        // Pr(pi) = Pr(p1)
        //   - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
        //   - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
        //   - 5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*d1a^4)*(xi - x1)^2
        //   - 5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*d1a^4)*(yi - y1)^2
        //   + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*d1a^4))*(xi - x1)*(yi - y1)
        // where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2

<span class="fc" id="L776">        final var x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L777">        final var y1 = fingerprintPosition.getInhomY();</span>

<span class="fc" id="L779">        final var xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L780">        final var ya = radioSourcePosition.getInhomY();</span>

<span class="fc" id="L782">        final var xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L783">        final var yi = estimatedPosition.getInhomY();</span>

<span class="fc" id="L785">        final var mean = new double[]{</span>
                fingerprintRssi, pathLossExponent, x1, y1, xa, ya, xi, yi
        };
<span class="fc" id="L788">        final var covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L789" title="All 2 branches covered.">                fingerprintRssiVariance != null ? fingerprintRssiVariance : 0.0,</span>
<span class="fc bfc" id="L790" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L794" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null</span>
<span class="pc bpc" id="L795" title="1 of 2 branches missed.">                &amp;&amp; fingerprintPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L796" title="1 of 2 branches missed.">                &amp;&amp; fingerprintPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="fc" id="L798">            covariance.setSubmatrix(2, 2, 3, 3,</span>
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L802" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null</span>
<span class="pc bpc" id="L803" title="1 of 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L804" title="1 of 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L805">            covariance.setSubmatrix(4, 4, 5, 5,</span>
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L809" title="All 2 branches covered.">        if (estimatedPositionCovariance != null</span>
<span class="pc bpc" id="L810" title="1 of 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L811" title="1 of 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L812">            covariance.setSubmatrix(6, 6, 7, 7,</span>
                    estimatedPositionCovariance);
        }

        try {
<span class="fc" id="L817">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(final double[] x, final double[] y, final Matrix jacobian) {

                    // Pr(pi) = Pr(p1)
                    //   - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    //   - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
                    //   - 5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*d1a^4)*(xi - x1)^2
                    //   - 5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*d1a^4)*(yi - y1)^2
                    //   + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*d1a^4))*(xi - x1)*(yi - y1)
                    // where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2

                    // Hence:
                    // Pr(pi) = Pr(p1)
                    //   - 10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*(xi - x1)
                    //   - 10*n*(y1 - ya)/(ln(10)*(x1 - xa)^2 + (y1 - ya)^2)*(yi - y1)
                    //   - 5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)^2
                    //   - 5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(yi - y1)^2
                    //   + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

<span class="fc" id="L837">                    final var diffX1a = x1 - xa;</span>
<span class="fc" id="L838">                    final var diffY1a = y1 - ya;</span>

<span class="fc" id="L840">                    final var diffXi1 = xi - x1;</span>
<span class="fc" id="L841">                    final var diffYi1 = yi - y1;</span>

<span class="fc" id="L843">                    final var diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L844">                    final var diffY1a2 = diffY1a * diffY1a;</span>

<span class="fc" id="L846">                    final var diffXi12 = diffXi1 * diffXi1;</span>
<span class="fc" id="L847">                    final var diffYi12 = diffYi1 * diffYi1;</span>

<span class="fc" id="L849">                    final var d1a2 = diffX1a2 + diffY1a2;</span>
<span class="fc" id="L850">                    final var d1a4 = d1a2 * d1a2;</span>
<span class="fc" id="L851">                    final var d1a8 = d1a4 * d1a4;</span>

<span class="fc" id="L853">                    final var ln10 = Math.log(10.0);</span>

<span class="fc" id="L855">                    y[0] = fingerprintRssi - 10.0 * pathLossExponent * diffX1a / (ln10 * d1a2) * diffXi1</span>
                            - 10.0 * pathLossExponent * diffY1a / (ln10 * d1a2) * diffYi1
                            - 5.0 * pathLossExponent * (-diffX1a2 + diffY1a2) / (ln10 * d1a4) * diffXi12
                            - 5.0 * pathLossExponent * (diffX1a2 - diffY1a2) / (ln10 * d1a4) * diffYi12
                            + 20.0 * pathLossExponent * diffX1a * diffY1a / (ln10 * d1a4) * diffXi1 * diffYi1;

                    // compute gradient (is a jacobian having 1 row and 8 columns)


                    // derivative of rssi respect to fingerprint rssi
<span class="fc" id="L865">                    final var derivativeFingerprintRssi = 1.0;</span>

                    // derivative of rssi respect to path-loss exponent

                    // diff(Pr(pi))/diff(n) = -10*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*(xi - x1)
                    //   -10*(y1 - ya)/(ln(10)*(x1 - xa)^2 + (y1 - ya)^2)*(yi - y1)
                    //   -5*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)^2
                    //   -5*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(yi - y1)^2
                    //   +20*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)
<span class="fc" id="L874">                    final var derivativePathLossExponent = -10.0 * diffX1a / (ln10 * d1a2) * diffXi1</span>
                            - 10.0 * diffY1a / (ln10 * d1a2) * diffYi1
                            - 5.0 * (-diffX1a2 + diffY1a2) / (ln10 * d1a4) * diffXi12
                            - 5.0 * (diffX1a2 - diffY1a2) / (ln10 * d1a4) * diffYi12
                            + 20.0 * diffX1a * diffY1a / (ln10 * d1a4) * diffXi1 * diffYi1;

                    // derivative of rssi respect to x1

                    // We have
                    // Pr(pi) = Pr(p1)
                    //   - 10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*(xi - x1)
                    //   - 10*n*(y1 - ya)/(ln(10)*(x1 - xa)^2 + (y1 - ya)^2)*(yi - y1)
                    //   - 5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)^2
                    //   - 5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(yi - y1)^2
                    //   + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

                    // Pr(pi) = Pr(p1)
                    //   - 10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))
                    //   + 5*n*((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)
                    //   + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

                    // and we know that: (f(x)/g(x))' = (f'(x)*g(x) - f(x)*g'(x))/g(x)^2
                    // and also that (f(x)*g(x))' = f'(x)*g(x) + f(x)*g'(x)

                    // Hence
                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(x1) =
                    //   diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(x1) =
                    //   diff(-x1^2 + (xi + xa)*x1 - xa*xi)/diff(x1) =
                    //   -2*x1 + xi + xa

                    // diff(((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))/diff(x1) =
                    //   2*(x1 - xa)*((xi - x1)^2 - (yi - y1)^2) - 2*(xi - x1)*((x1 - xa)^2 - (y1 - ya)^2)

                    // diff((x1 - xa)*(y1 - ya))/diff(x1) =
                    //   y1 - ya

                    // diff((xi - x1)*(yi - y1))/diff(x1) =
                    //  -(yi - y1)

                    // diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(x1) =
                    //   (y1 - ya)*(xi - x1)*(yi - y1) - (x1 - xa)*(y1 - ya)*(yi - y1) =
                    //   ((y1 - ya)*(xi - x1) - (x1 - xa)*(y1 - ya))*(yi - y1)

                    // diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //   + 5*n/ln(10)*(2*((x1 - xa)*((xi - x1)^2 - (yi - y1)^2) - (xi - x1)*((x1 - xa)^2 - (y1 - ya)^2))*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))*2*((x1 - xa)^2 + (y1 - ya)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^4
                    //   + 20*n/ln(10)*(((y1 - ya)*(xi - x1) - (x1 - xa)*(y1 - ya))*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*2*((x1 - xa)^2 + (y1 - ya)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^4

                    // diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(x1 - xa))/d1a^4
                    //   + 5*n/ln(10)*(2*((x1 - xa)*((xi - x1)^2 - (yi - y1)^2) - (xi - x1)*((x1 - xa)^2 - (y1 - ya)^2))*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))*4*d1a^2*(x1 - xa))/d1a^8
                    //   + 20*n/ln(10)*(((y1 - ya)*(xi - x1) - (x1 - xa)*(y1 - ya))*(yi - y1)*d1a^4 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(x1 - xa))/d1a^8
<span class="fc" id="L924">                    final var crossDiff = diffX1a * diffXi1 + diffY1a * diffYi1;</span>
<span class="fc" id="L925">                    final var tmpX = crossDiff * 2.0 * diffX1a;</span>
<span class="fc" id="L926">                    final var tmpX2 = (diffX1a2 - diffY1a2) * (diffXi12 - diffYi12) * 4.0 * d1a2 * diffX1a;</span>
<span class="fc" id="L927">                    final var tmpX3 = diffX1a * diffY1a * diffXi1 * diffYi1 * 4.0 * d1a2 * diffX1a;</span>
<span class="fc" id="L928">                    final var derivativeX1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * x1 + xi + xa) * d1a2 - tmpX) / d1a4</span>
                            + 5.0 * pathLossExponent / ln10 * (2.0 * (diffX1a * (diffXi12 - diffYi12) - diffXi1 * (diffX1a2 - diffY1a2)) * d1a4 - tmpX2) / d1a8
                            + 20.0 * pathLossExponent / ln10 * ((diffY1a * diffXi1 - diffX1a * diffY1a) * diffYi1 * d1a4 - tmpX3) / d1a8;

                    // derivative of rssi respect to y1

                    // We have
                    // Pr(pi) = Pr(p1)
                    //   - 10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*(xi - x1)
                    //   - 10*n*(y1 - ya)/(ln(10)*(x1 - xa)^2 + (y1 - ya)^2)*(yi - y1)
                    //   - 5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)^2
                    //   - 5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(yi - y1)^2
                    //   + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

                    // Pr(pi) = Pr(p1)
                    //   - 10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))
                    //   + 5*n*((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)
                    //   + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

                    // and we know that: (f(x)/g(x))' = (f'(x)*g(x) - f(x)*g'(x))/g(x)^2
                    // and also that (f(x)*g(x))' = f'(x)*g(x) + f(x)*g'(x)

                    // Hence
                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(y1) =
                    //   diff(y1*yi -ya*yi -y1^2 + ya*y1)/diff(y1) =
                    //   diff(-y1^2 + (yi + ya)*y1 - ya*yi)/diff(y1) =
                    //   -2*y1 + yi + ya

                    // diff(((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))/diff(y1) =
                    //   -2*(y1 - ya)*((xi - x1)^2 - (yi - y1)^2) + 2*(yi - y1)*((x1 - xa)^2 - (y1 - ya)^2)

                    // diff((x1 - xa)*(y1 - ya))/diff(y1) =
                    //   x1 - xa

                    // diff((xi - x1)*(yi - y1))/diff(y1) =
                    //  -(xi - x1)

                    // diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(y1) =
                    //   (x1 - xa)*(xi - x1)*(yi - y1) - (x1 - xa)*(y1 - ya)*(xi - x1) =
                    //   ((x1 - xa)*(yi - y1) - (x1 - xa)*(y1 - ya))*(xi - x1)

                    // diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //   + 5*n/ln(10)*(2*(-(y1 - ya)*((xi - x1)^2 - (yi - y1)^2) + (yi - y1)*((x1 - xa)^2 - (y1 - ya)^2))*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2)*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^4
                    //   + 20*n/ln(10)*(((x1 - xa)*(yi - y1) - (x1 - xa)*(y1 - ya))*(xi - x1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*2*((x1 - xa)^2 + (y1 - ya)^2)*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^4

                    // diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(y1 - ya))/d1a^4
                    //   + 5*n/ln(10)*(2*(-(y1 - ya)*((xi - x1)^2 - (yi - y1)^2) + (yi - y1)*((x1 - xa)^2 - (y1 - ya)^2))*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*4*d1a^2*(y1 - ya))/d1a^8
                    //   + 20*n/ln(10)*(((x1 - xa)*(yi - y1) - (x1 - xa)*(y1 - ya))*(xi - x1)*d1a^4 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(y1 - ya))/d1a^8
<span class="fc" id="L976">                    final var tmpY = crossDiff * 2.0 * diffY1a;</span>
<span class="fc" id="L977">                    final var tmpY2 = (diffX1a2 - diffY1a2) * (diffXi12 - diffYi12) * 4.0 * d1a2 * diffY1a;</span>
<span class="fc" id="L978">                    final var tmpY3 = diffX1a * diffY1a * diffXi1 * diffYi1 * 4.0 * d1a2 * diffY1a;</span>
<span class="fc" id="L979">                    final var derivativeY1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * y1 + yi + ya) * d1a2 - tmpY) / d1a4</span>
                            + 5.0 * pathLossExponent / ln10 * (2.0 * (-diffY1a * (diffXi12 - diffYi12) + diffYi1 * (diffX1a2 - diffY1a2)) * d1a4 - tmpY2) / d1a8
                            + 20.0 * pathLossExponent / ln10 * ((diffX1a * diffYi1 - diffX1a * diffY1a) * diffXi1 * d1a4 - tmpY3) / d1a8;

                    // derivative of rssi respect to xa

                    // Pr(pi) = Pr(p1)
                    //   - 10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))
                    //   + 5*n*((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)
                    //   + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(xa) =
                    //   -(xi - x1)

                    // diff(((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))/diff(xa) =
                    //   -2*(x1 - xa)*((xi - x1)^2 - (yi - y1)^2)

                    // diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(xa) =
                    //   -(y1 - ya)*(xi - x1)*(yi - y1)

                    // diff(Pr(pi))/diff(xa) = -10*n/ln(10)*(-(xi - x1)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //   + 5*n/ln(10)*(-2*(x1 - xa)*((xi - x1)^2 - (yi - y1)^2)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^4
                    //   + 20*n*(-(y1 - ya)*(xi - x1)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*2*((x1 - xa)^2 + (y1 - ya)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^4

                    // diff(Pr(pi))/diff(xa) = -10*n/ln(10)*(-(xi - x1)*d1a^2 + ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(x1 - xa))/d1a^4
                    //   + 5*n/ln(10)*(-2*(x1 - xa)*((xi - x1)^2 - (yi - y1)^2)*d1a^4 + ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*4*d1a^2*(x1 - xa))/d1a^8
                    //   + 20*n/ln(10)*(-(y1 - ya)*(xi - x1)*(yi - y1)*d1a^4 + (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(x1 - xa))/d1a^8
<span class="fc" id="L1006">                    final var derivativeXa = -10.0 * pathLossExponent / ln10 * (-diffXi1 * d1a2 + tmpX) / d1a4</span>
                            + 5.0 * pathLossExponent / ln10 * (-2.0 * diffX1a * (diffXi12 - diffYi12) * d1a4 + tmpX2) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (-diffY1a * diffXi1 * diffYi1 * d1a4 + tmpX3) / d1a8;

                    // derivative of rssi respect to ya

                    // Pr(pi) = Pr(p1)
                    //   - 10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))
                    //   + 5*n*((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)
                    //   + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(ya) =
                    //   -(yi - y1)

                    // diff(((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))/diff(ya) =
                    //   2*(y1 - ya)*((xi - x1)^2 - (yi - y1)^2)

                    // diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(ya) =
                    //   -(x1 - xa)*(xi - x1)*(yi - y1)

                    // diff(Pr(pi))/diff(ya) = -10*n/ln(10)*(-(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //   + 5*n/ln(10)*(2*(y1 - ya)*((xi - x1)^2 - (yi - y1)^2)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2)*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^4
                    //   + 20*n/ln(10)*(-(x1 - xa)*(xi - x1)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*2*((x1 - xa)^2 + (y1 - ya)^2)*-2(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^4

                    // diff(Pr(pi))/diff(ya) = -10*n/ln(10)*(-(yi - y1)*d1a^2 + ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(y1 - ya))/d1a^4
                    //   + 5*n/ln(10)*(2*(y1 - ya)*((xi - x1)^2 - (yi - y1)^2)*d1a^4 + ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*4*d1a^2*(y1 - ya))/d1a^8
                    //   + 20*n/ln(10)*(-(x1 - xa)*(xi - x1)*(yi - y1)*d1a^4 + (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(y1 - ya))/d1a^8
<span class="fc" id="L1033">                    final var derivativeYa = -10.0 * pathLossExponent / ln10 * (-diffYi1 * d1a2 + tmpY) / d1a4</span>
                            + 5.0 * pathLossExponent / ln10 * (2.0 * diffY1a * (diffXi12 - diffYi12) * d1a4 + tmpY2) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (-diffX1a * diffXi1 * diffYi1 * d1a4 + tmpY3) / d1a8;

                    // derivative of rssi respect to xi

                    // Pr(pi) = Pr(p1)
                    //   - 10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))
                    //   + 5*n*((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)
                    //   + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(xi) =
                    //   x1 - xa

                    // diff(((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))/diff(xi) =
                    //   2*((x1 - xa)^2 - (y1 - ya)^2)*(xi - x1)

                    // diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(xi) =
                    //   (x1 - xa)*(y1 - ya)*(yi - y1)

                    // diff(Pr(pi))/diff(xi) = -10*n/ln(10)*((x1 - xa)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*0)/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //   + 5*n/ln(10)*(2*((x1 - xa)^2 - (y1 - ya)^2)*(xi - x1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2)^4
                    //   + 20*n/ln(10)*((x1 - xa)*(y1 - ya)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*0)/((x1 - xa)^2 + (y1 - ya)^2)^4

                    // diff(Pr(pi))/diff(xi) = -10*n/ln(10)*((x1 - xa)*d1a^2)/d1a^4
                    //   + 5*n/ln(10)*(2*((x1 - xa)^2 - (y1 - ya)^2)*(xi - x1)*d1a^4)/d1a^8
                    //   + 20*n/ln(10)*((x1 - xa)*(y1 - ya)*(yi - y1)*d1a^4)/d1a^8

                    // diff(Pr(pi))/diff(xi) = -10*n/ln(10)*(x1 - xa)/d1a^2
                    //   + 10*n/ln(10)*(((x1 - xa)^2 - (y1 - ya)^2)*(xi - x1))/d1a^4
                    //   + 20*n/ln(10)*(x1 - xa)*(y1 - ya)*(yi - y1)/d1a^4
<span class="fc" id="L1064">                    final var derivativeXi = -10.0 * pathLossExponent / ln10 * diffX1a / d1a2</span>
                            + 10.0 * pathLossExponent / ln10 * ((diffX1a2 - diffY1a2) * diffXi1) / d1a4
                            + 20.0 * pathLossExponent / ln10 * diffX1a * diffY1a * diffYi1 / d1a4;

                    // derivative of rssi respect to yi

                    // Pr(pi) = Pr(p1)
                    //   - 10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))
                    //   + 5*n*((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)
                    //   + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(yi) =
                    //   y1 - ya

                    // diff(((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))/diff(yi) =
                    //   2*((x1 - xa)^2 - (y1 - ya)^2)*(yi - y1)

                    // diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(yi) =
                    //   (x1 - xa)*(y1 - ya)*(xi - x1)

                    // diff(Pr(pi))/diff(yi) = -10*n/ln(10)*((y1 - ya)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*0)/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //   + 5*n/ln(10)*(2*((x1 - xa)^2 - (y1 - ya)^2)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2)^4
                    //   + 20*n/ln(10)*((x1 - xa)*(y1 - ya)*(xi - x1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*0)/((x1 - xa)^2 + (y1 - ya)^2)^4

                    // diff(Pr(pi))/diff(yi) = -10*n/ln(10)*((y1 - ya)*d1a^2)/d1a^4
                    //   + 5*n/ln(10)*(2*((x1 - xa)^2 - (y1 - ya)^2)*(yi - y1)*d1a^4)/d1a^8
                    //   + 20*n/ln(10)*((x1 - xa)*(y1 - ya)*(xi - x1)*d1a^4)/d1a^8

                    // diff(Pr(pi))/diff(yi) = -10*n/ln(10)*(y1 - ya)/d1a^2
                    //   + 10*n/ln(10)*(((x1 - xa)^2 - (y1 - ya)^2)*(yi - y1))/d1a^4
                    //   + 20*n/ln(10)*(x1 - xa)*(y1 - ya)*(xi - x1)/d1a^4
<span class="fc" id="L1095">                    final var derivativeYi = -10.0 * pathLossExponent / ln10 * diffY1a / d1a2</span>
                            + 10.0 * pathLossExponent / ln10 * ((diffX1a2 - diffY1a2) * diffYi1) / d1a4
                            + 20.0 * pathLossExponent / ln10 * diffX1a * diffY1a * diffXi1 / d1a4;

                    // set derivatives fingerprintRssi, pathLossExponent, x1, y1, xa, ya, xi, yi
<span class="fc" id="L1100">                    jacobian.setElementAtIndex(0, derivativeFingerprintRssi);</span>
<span class="fc" id="L1101">                    jacobian.setElementAtIndex(1, derivativePathLossExponent);</span>
<span class="fc" id="L1102">                    jacobian.setElementAtIndex(2, derivativeX1);</span>
<span class="fc" id="L1103">                    jacobian.setElementAtIndex(3, derivativeY1);</span>
<span class="fc" id="L1104">                    jacobian.setElementAtIndex(4, derivativeXa);</span>
<span class="fc" id="L1105">                    jacobian.setElementAtIndex(5, derivativeYa);</span>
<span class="fc" id="L1106">                    jacobian.setElementAtIndex(6, derivativeXi);</span>
<span class="fc" id="L1107">                    jacobian.setElementAtIndex(7, derivativeYi);</span>
<span class="fc" id="L1108">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L1112">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L1115">        } catch (final AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L1116">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (fingerprint rssi variance, path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * rssi variance by considering the 3D 1st order Taylor expression of received power.
     * Notice that any unknown variance is assumed to be zero.
     *
     * @param fingerprintRssi               closest located fingerprint reading RSSI expressed in dBm's.
     * @param pathLossExponent              path-loss exponent.
     * @param fingerprintPosition           position of closest fingerprint.
     * @param radioSourcePosition           radio source position associated to fingerprint reading.
     * @param estimatedPosition             position to be estimated. Usually this is equal to the
     *                                      initial position used by a non-linear algorithm.
     * @param fingerprintRssiVariance       variance of fingerprint RSSI or null if unknown.
     * @param pathLossExponentVariance      variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance   covariance of position to be estimated or null
     *                                      if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiVarianceSecondOrderNonLinear3D(
            final double fingerprintRssi, final double pathLossExponent, final Point3D fingerprintPosition,
            final Point3D radioSourcePosition, final Point3D estimatedPosition, final Double fingerprintRssiVariance,
            final Double pathLossExponentVariance, final Matrix fingerprintPositionCovariance,
            final Matrix radioSourcePositionCovariance, final Matrix estimatedPositionCovariance)
            throws IndoorException {

<span class="fc bfc" id="L1150" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null || estimatedPosition == null) {</span>
<span class="fc" id="L1151">            return null;</span>
        }

        // 2nd order Taylor expression of received power in 3D:
        // Pr(pi) = Pr(p1)
        //  - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
        //  - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
        //  - 10*n*(z1 - za)/(ln(10)*d1a^2)*(zi - z1)
        //  - 5*n*((y1 - ya)^2 + (z1 - za)^2) - (x1 - xa)^2)/(ln(10)*d1a^4)*(xi - x1)^2
        //  - 5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*d1a^4)*(yi - y1)^2
        //  - 5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*d1a^4)*(zi - z1)^2
        //  + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*d1a^4)*(xi - x1)*(yi - y1)
        //  + 20*n*(y1 - ya)*(z1 - za)/(ln(10)*d1a^4)*(yi - y1)*(zi - z1)
        //  + 20*n*(x1 - xa)*(z1 - za)/(ln(10)*d1a^4)*(xi - x1)*(zi - z1)
        // where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2

<span class="fc" id="L1167">        final var x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L1168">        final var y1 = fingerprintPosition.getInhomY();</span>
<span class="fc" id="L1169">        final var z1 = fingerprintPosition.getInhomZ();</span>

<span class="fc" id="L1171">        final var xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L1172">        final var ya = radioSourcePosition.getInhomY();</span>
<span class="fc" id="L1173">        final var za = radioSourcePosition.getInhomZ();</span>

<span class="fc" id="L1175">        final var xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L1176">        final var yi = estimatedPosition.getInhomY();</span>
<span class="fc" id="L1177">        final var zi = estimatedPosition.getInhomZ();</span>

<span class="fc" id="L1179">        final var mean = new double[]{</span>
                fingerprintRssi, pathLossExponent, x1, y1, z1, xa, ya, za, xi, yi, zi
        };
<span class="fc" id="L1182">        final var covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L1183" title="All 2 branches covered.">                fingerprintRssiVariance != null ? fingerprintRssiVariance : 0.0,</span>
<span class="fc bfc" id="L1184" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L1188" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null</span>
<span class="pc bpc" id="L1189" title="1 of 2 branches missed.">                &amp;&amp; fingerprintPositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L1190" title="1 of 2 branches missed.">                &amp;&amp; fingerprintPositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="fc" id="L1192">            covariance.setSubmatrix(2, 2, 4, 4,</span>
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L1196" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null</span>
<span class="pc bpc" id="L1197" title="1 of 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L1198" title="1 of 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L1199">            covariance.setSubmatrix(5, 5, 7, 7,</span>
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L1203" title="All 2 branches covered.">        if (estimatedPositionCovariance != null</span>
<span class="pc bpc" id="L1204" title="1 of 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L1205" title="1 of 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L1206">            covariance.setSubmatrix(8, 8, 10, 10,</span>
                    estimatedPositionCovariance);
        }

        try {
<span class="fc" id="L1211">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(final double[] x, final double[] y, final Matrix jacobian) {

                    // Pr(pi) = Pr(p1)
                    //  - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    //  - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
                    //  - 10*n*(z1 - za)/(ln(10)*d1a^2)*(zi - z1)
                    //  - 5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*d1a^4)*(xi - x1)^2
                    //  - 5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*d1a^4)*(yi - y1)^2
                    //  - 5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*d1a^4)*(zi - z1)^2
                    //  + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*d1a^4)*(xi - x1)*(yi - y1)
                    //  + 20*n*(y1 - ya)*(z1 - za)/(ln(10)*d1a^4)*(yi - y1)*(zi - z1)
                    //  + 20*n*(x1 - xa)*(z1 - za)/(ln(10)*d1a^4)*(xi - x1)*(zi - z1)
                    // where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2

                    // Hence:
                    // Pr(pi) = Pr(p1)
                    //   -10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(xi - x1)
                    //   -10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(yi - y1)
                    //   -10*n*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(zi - z1)
                    //   -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //   -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //   -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //   +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //   +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //   +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

<span class="fc" id="L1239">                    final var diffX1a = x1 - xa;</span>
<span class="fc" id="L1240">                    final var diffY1a = y1 - ya;</span>
<span class="fc" id="L1241">                    final var diffZ1a = z1 - za;</span>

<span class="fc" id="L1243">                    final var diffXi1 = xi - x1;</span>
<span class="fc" id="L1244">                    final var diffYi1 = yi - y1;</span>
<span class="fc" id="L1245">                    final var diffZi1 = zi - z1;</span>

<span class="fc" id="L1247">                    final var diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L1248">                    final var diffY1a2 = diffY1a * diffY1a;</span>
<span class="fc" id="L1249">                    final var diffZ1a2 = diffZ1a * diffZ1a;</span>

<span class="fc" id="L1251">                    final var diffXi12 = diffXi1 * diffXi1;</span>
<span class="fc" id="L1252">                    final var diffYi12 = diffYi1 * diffYi1;</span>
<span class="fc" id="L1253">                    final var diffZi12 = diffZi1 * diffZi1;</span>

<span class="fc" id="L1255">                    final var d1a2 = diffX1a2 + diffY1a2 + diffZ1a2;</span>
<span class="fc" id="L1256">                    final var d1a4 = d1a2 * d1a2;</span>
<span class="fc" id="L1257">                    final var d1a8 = d1a4 * d1a4;</span>

<span class="fc" id="L1259">                    final var ln10 = Math.log(10.0);</span>
<span class="fc" id="L1260">                    final var crossDiff = diffX1a * diffXi1 + diffY1a * diffYi1 + diffZ1a * diffZi1;</span>

                    // Pr(pi) = Pr(p1)
                    //   -10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(xi - x1)
                    //   -10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(yi - y1)
                    //   -10*n*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(zi - z1)
                    //   -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //   -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //   -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //   +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //   +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //   +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

<span class="fc" id="L1273">                    y[0] = fingerprintRssi - 10.0 * pathLossExponent * diffX1a / (ln10 * d1a2) * diffXi1</span>
                            - 10.0 * pathLossExponent * diffY1a / (ln10 * d1a2) * diffYi1
                            - 10.0 * pathLossExponent * diffZ1a / (ln10 * d1a2) * diffZi1
                            - 5.0 * pathLossExponent * (-diffX1a2 + diffY1a2 + diffZ1a2) / (ln10 * d1a4) * diffXi12
                            - 5.0 * pathLossExponent * (diffX1a2 - diffY1a2 + diffZ1a2) / (ln10 * d1a4) * diffYi12
                            - 5.0 * pathLossExponent * (diffX1a2 + diffY1a2 - diffZ1a2) / (ln10 * d1a4) * diffZi12
                            + 20.0 * pathLossExponent * diffX1a * diffY1a / (ln10 * d1a4) * diffXi1 * diffYi1
                            + 20.0 * pathLossExponent * diffY1a * diffZ1a / (ln10 * d1a4) * diffYi1 * diffZi1
                            + 20.0 * pathLossExponent * diffX1a * diffZ1a / (ln10 * d1a4) * diffXi1 * diffZi1;

                    // compute gradient (is a jacobian having 1 row and 11 columns)

                    // derivative of rssi respect to fingerprint rssi
<span class="fc" id="L1286">                    final var derivativeFingerprintRssi = 1.0;</span>

                    // derivative of rssi respect to path-loss exponent

                    // diff(Pr(pi))/diff(n) = -10*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    //   -10*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
<span class="fc" id="L1292">                    final var derivativePathLossExponent = -10.0 * diffX1a / (ln10 * d1a2) * diffXi1</span>
                            - 10.0 * diffY1a / (ln10 * d1a2) * diffYi1
                            - 10.0 * diffZ1a / (ln10 * d1a2) * diffZi1
                            - 5.0 * (-diffX1a2 + diffY1a2 + diffZ1a2) / (ln10 * d1a4) * diffXi12
                            - 5.0 * (diffX1a2 - diffY1a2 + diffZ1a2) / (ln10 * d1a4) * diffYi12
                            - 5.0 * (diffX1a2 + diffY1a2 - diffZ1a2) / (ln10 * d1a4) * diffZi12
                            + 20.0 * diffX1a * diffY1a / (ln10 * d1a4) * diffXi1 * diffYi1
                            + 20.0 * diffY1a * diffZ1a / (ln10 * d1a4) * diffYi1 * diffZi1
                            + 20.0 * diffX1a * diffZ1a / (ln10 * d1a4) * diffXi1 * diffZi1;

                    // derivative of rssi respect to x1

                    // We have
                    // Pr(pi) = Pr(p1)
                    //   -10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(xi - x1)
                    //   -10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(yi - y1)
                    //   -10*n*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(zi - z1)
                    //   -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //   -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //   -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //   +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //   +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //   +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    // Pr(pi) = Pr(p1)
                    //   -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //   -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //   -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //   -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //   +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //   +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //   +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    // and we know that: (f(x)/g(x))' = (f'(x)*g(x) - f(x)*g'(x))/g(x)^2
                    // and also that (f(x)*g(x))' = f'(x)*g(x) + f(x)*g'(x)

                    // Hence
                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(x1) =
                    //   diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(x1) =
                    //   diff(-x1^2 + (xi + xa)*x1 - xa*xi)/diff(x1) =
                    //   -2*x1 + xi + xa

                    // diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(x1) =
                    //   diff(-(x1 - xa)^2*(xi - x1)^2)/diff(x1) =
                    //   -2*(x1 - xa)*(xi - x1)^2 - 2*(xi - x1)*(-(x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)
                    //   -2*((x1 - xa)*(xi - x1)^2 + (xi - x1)*(-(x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

                    // diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(x1) =
                    //   diff((x1 - xa)^2*(yi - y1)^2)/diff(x1) =
                    //   2*(x1 - xa)*(yi - y1)^2

                    // diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(z1 - za)^2)/diff(x1) =
                    //   diff((x1 - xa)^2*(z1 - za)^2)/diff(x1) =
                    //   2*(x1 - xa)*(z1 - za)^2

                    // diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(x1) =
                    //   (y1 - ya)*(yi - y1)*((xi - x1) - (x1 - xa)) =
                    //   (y1 - ya)*(yi - y1)*(-2*x1 + xi + xa)

                    // diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(x1) = 0

                    // diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(x1) =
                    //   (z1 - za)*(zi - z1)*((xi - x1) - (x1 - xa)) =
                    //   (z1 - za)*(zi - z1)*(-2*x1 + xi + xa)

                    // diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //   -5*n/ln(10)*(-2*((x1 - xa)*(xi - x1)^2 + (xi - x1)*(-(x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(2*(x1 - xa)*(yi - y1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(2*(x1 - xa)*(z1 - za)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(z1 - za)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*((y1 - ya)*(yi - y1)*(-2*x1 + xi + xa)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*((z1 - za)*(zi - z1)*(-2*x1 + xi + xa)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    // diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(x1 - xa))/d1a^4
                    //   -5*n/ln(10)*(-2*((x1 - xa)*(xi - x1)^2 + (xi - x1)*(-(x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*d1a^4 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*4*d1a^2*(x1 - xa))/d1a^8
                    //   -5*n/ln(10)*(2*(x1 - xa)*(yi - y1)^2*d1a^4 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*4*d1a^2*(x1 - xa))/d1a^8
                    //   -5*n/ln(10)*(2*(x1 - xa)*(z1 - za)^2*d1a^4 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(z1 - za)^2)*4*d1a^2*(x1 - xa))/d1a^8
                    //   +20*n/ln(10)*((y1 - ya)*(yi - y1)*(-2*x1 + xi + xa)*d1a^4 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(x1 - xa))/d1a^8
                    //   +20*n/ln(10)*(-(y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*4*d1a^2*(x1 - xa))/d1a^8
                    //   +20*n/ln(10)*((z1 - za)*(zi - z1)*(-2*x1 + xi + xa)*d1a^4 - (x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1)*4*d1a^2*(x1 - xa))/d1a^8
<span class="fc" id="L1372">                    final var tmp1 = (diffY1a2 + diffZ1a2 - diffX1a2) * diffXi12 * 4.0 * d1a2 * diffX1a;</span>
<span class="fc" id="L1373">                    final var tmp2 = diffX1a * diffY1a * diffXi1 * diffYi1 * 4.0 * d1a2 * diffX1a;</span>
<span class="fc" id="L1374">                    final var tmp3 = diffX1a * diffZ1a * diffXi1 * diffZi1 * 4.0 * d1a2 * diffX1a;</span>
<span class="fc" id="L1375">                    final var derivativeX1 = -10.0 * pathLossExponent / ln10 * ((-2 * x1 + xi + xa) * d1a2 - crossDiff * 2.0 * diffX1a) / d1a4</span>
                            - 5.0 * pathLossExponent / ln10 * (-2.0 * (diffX1a * diffXi12 + diffXi1 * (-diffX1a2 + diffY1a2 + diffZ1a2)) * d1a4 - tmp1) / d1a8
                            - 5.0 * pathLossExponent / ln10 * (2.0 * diffX1a * diffYi12 * d1a4 - tmp1) / d1a8
                            - 5.0 * pathLossExponent / ln10 * (2.0 * diffX1a * diffZ1a2 * d1a4 - (diffX1a2 + diffY1a2 - diffZ1a2) * diffZ1a2 * 4.0 * d1a2 * diffX1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (diffY1a * diffYi1 * (-2.0 * x1 + xi + xa) * d1a4 - tmp2) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (-diffY1a * diffZ1a * diffYi1 * diffZi1 * 4.0 * d1a2 * diffX1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (diffZ1a * diffZi1 * (-2.0 * x1 + xi + xa) * d1a4 - tmp3) / d1a8;

                    // derivative of rssi respect to y1

                    // We have
                    // Pr(pi) = Pr(p1)
                    //   -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //   -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //   -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //   -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //   +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //   +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //   +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    // Hence
                    // diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(y1) =
                    //   diff(y1*yi - ya*yi -y1^2 + ya*y1)/diff(y1) =
                    //   diff(-y1^2 + (yi + ya)*y1 - ya*yi)/diff(y1) =
                    //   -2*y1 + yi + ya

                    // diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(y1) =
                    //   2*(y1 - ya)*(xi - x1)^2

                    // diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(y1) =
                    //   -2*(y1 - ya)*(yi - y1)^2 -2*(yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)
                    //   -2*((y1 - ya)*(yi - y1)^2 + (yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2))

                    // diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(y1) =
                    //   2*(y1 - ya)*(zi - z1)^2

                    // diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(y1) =
                    //   (x1 - xa)*(xi - x1)*(yi - y1) - (xi - x1)*(x1 - xa)*(y1 - ya) =
                    //   (x1 - xa)*((xi - x1)*(yi - y1) - (xi - x1)*(y1 - ya)) =
                    //   (x1 - xa)*(xi - x1)*(-2*y1 + yi + ya)

                    // diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(y1) =
                    //   (z1 - za)*(yi - y1)*(zi - z1) - (zi - z1)*(y1 - ya)*(z1 - za) =
                    //   (z1 - za)*((yi - y1)*(zi - z1) - (zi - z1)*(y1 - ya)) =
                    //   (z1 - za)*(zi - z1)*(-2*y1 + yi + ya)

                    // diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(y1) = 0

                    // diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //   -5*n/ln(10)*(2*(y1 - ya)*(xi - x1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(-2*((y1 - ya)*(yi - y1)^2 + (yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2))*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2*2((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2(y1 -ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(2*(y1 - ya)*(zi - z1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*((x1 - xa)*(xi - x1)*(-2*y1 + yi + ya)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*((z1 - za)*(zi - z1)*(-2*y1 + yi + ya)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    // diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(y1 - ya))/d1a^4
                    //   -5*n/ln(10)*(2*(y1 - ya)*(xi - x1)^2*d1a^4 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*4*d1a^2*(y1 - ya))/d1a^8
                    //   -5*n/ln(10)*(-2*((y1 - ya)*(yi - y1)^2 + (yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2))*d1a^4 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*4*d1a^2*(y1 -ya))/d1a^8
                    //   -5*n/ln(10)*(2*(y1 - ya)*(zi - z1)^2*d1a^4 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*4*d1a^2*(y1 - ya))/d1a^8
                    //   +20*n/ln(10)*((x1 - xa)*(xi - x1)*(-2*y1 + yi + ya)*d1a^4 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(y1 - ya))/d1a^8
                    //   +20*n/ln(10)*((z1 - za)*(zi - z1)*(-2*y1 + yi + ya)*d1a^4 - (y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*4*d1a^2*(y1 - ya))/d1a^8
                    //   +20*n/ln(10)*(-(x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1)*4*d1a^2*(y1 - ya))/d1a^8
<span class="fc" id="L1438">                    final var tmp4 = diffY1a * diffZ1a * diffYi1 * diffZi1 * 4.0 * d1a2 * diffY1a;</span>
<span class="fc" id="L1439">                    final var derivativeY1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * y1 + yi + ya) * d1a2 - crossDiff * 2.0 * diffY1a) / d1a4</span>
                            - 5.0 * pathLossExponent / ln10 * (2.0 * diffY1a * diffXi12 * d1a4 - (-diffX1a2 + diffY1a2 + diffZ1a2) * diffXi12 * 4.0 * d1a2 * diffY1a) / d1a8
                            - 5.0 * pathLossExponent / ln10 * (-2.0 * (diffY1a * diffYi12 + diffYi1 * (diffX1a2 - diffY1a2 + diffZ1a2)) * d1a4 - (diffX1a2 - diffY1a2 + diffZ1a2) * diffYi12 * 4.0 * d1a2 * diffY1a) / d1a8
                            - 5.0 * pathLossExponent / ln10 * (2.0 * diffY1a * diffZi12 * d1a4 - (diffX1a2 + diffY1a2 - diffZ1a2) * diffZi12 * 4.0 * d1a2 * diffY1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (diffX1a * diffXi1 * (-2.0 * y1 + yi + ya) * d1a4 - diffX1a * diffY1a * diffXi1 * diffYi1 * 4.0 * d1a2 * diffY1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (diffZ1a * diffZi1 * (-2.0 * y1 + yi + ya) * d1a4 - tmp4) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (-diffX1a * diffZ1a * diffXi1 * diffZi1 * 4.0 * d1a2 * diffY1a) / d1a8;

                    // derivative of rssi respect to z1

                    // We have
                    // Pr(pi) = Pr(p1)
                    //   -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //   -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //   -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //   -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //   +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //   +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //   +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    // Hence
                    // diff(((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))/diff(z1) =
                    //   diff(z1*zi -za*zi -z1^2 + za*z1)/diff(z1) =
                    //   diff(-z1^2 + (zi + za)*z1 - za*zi)/diff(z1) =
                    //   -2*z1 + zi + za

                    // diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(z1) =
                    //   2*(z1 - za)*(xi - x1)^2

                    // diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(z1) =
                    //   2*(z1 - za)*(yi - y1)^2

                    // diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(z1) =
                    //   2*(z1 - za)*(zi - z1)^2 + 2*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)
                    //   2*((z1 - za)*(zi - z1)^2 + (zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2))

                    // diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(z1) = 0

                    // diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(z1) =
                    //   (y1 - ya)*(yi - y1)*(zi - z1) - (yi - y1)*(y1 - ya)*(z1 - za) =
                    //   (y1 - ya)*((yi - y1)*(zi - z1) - (yi - y1)*(z1 - za)) =
                    //   (y1 - ya)*(yi - y1)*(-2*z1 + zi + za)

                    // diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(z1) =
                    //   (x1 - xa)*(xi - x1)*(zi - z1) - (xi - x1)*(x1 - xa)*(z1 - za) =
                    //   (x1 - xa)*((xi - x1)*(zi - z1) - (xi - x1)*(z1 - za)) =
                    //   (x1 - xa)*(xi - x1)*(-2*z1 + zi + za)

                    // diff(Pr(pi))/diff(z1) = -10*n/ln(10)*((-2*z1 + zi + za)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //   -5*n/ln(10)*(2*(z1 - za)*(xi - x1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(2*(z1 - za)*(yi - y1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(2*((z1 - za)*(zi - z1)^2 + (zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2))*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2 - ((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*((y1 - ya)*(yi - y1)*(-2*z1 + zi + za)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*((x1 - xa)*(xi - x1)*(-2*z1 + zi + za)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    // diff(Pr(pi))/diff(z1) = -10*n/ln(10)*((-2*z1 + zi + za)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(z1 - za))/d1a^4
                    //   -5*n/ln(10)*(2*(z1 - za)*(xi - x1)^2*d1a^4 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*4*d1a^2*(z1 - za))/d1a^8
                    //   -5*n/ln(10)*(2*(z1 - za)*(yi - y1)^2*d1a^4 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*4*d1a^2*(z1 - za))/d1a^8
                    //   -5*n/ln(10)*(2*((z1 - za)*(zi - z1)^2 + (zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2))*d1a^4 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*4*d1a^2*(z1 - za))/d1a^8
                    //   +20*n/ln(10)*(-(x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(z1 - za))/d1a^8
                    //   +20*n/ln(10)*((y1 - ya)*(yi - y1)*(-2*z1 + zi + za)*d1a^4 - ((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))*4*d1a^2*(z1 - za))/d1a^8
                    //   +20*n/ln(10)*((x1 - xa)*(xi - x1)*(-2*z1 + zi + za)*d1a^4 - ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*4*d1a^2*(z1 - za))/d1a^8
<span class="fc" id="L1502">                    final var derivativeZ1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * z1 + zi + za) * d1a2 - crossDiff * 2.0 * diffZ1a) / d1a4</span>
                            - 5.0 * pathLossExponent / ln10 * (2.0 * diffZ1a * diffXi12 * d1a4 - ((-diffX1a2 + diffY1a2 + diffZ1a2) * diffXi12) * 4.0 * d1a2 * diffZ1a) / d1a8
                            - 5.0 * pathLossExponent / ln10 * (2.0 * diffZ1a * diffYi12 * d1a4 - ((diffX1a2 - diffY1a2 + diffZ1a2) * diffYi12) * 4.0 * d1a2 * diffZ1a) / d1a8
                            - 5.0 * pathLossExponent / ln10 * (2.0 * (diffZ1a * diffZi12 + diffZi1 * (diffX1a2 + diffY1a2 - diffZ1a2)) * d1a4 - ((diffX1a2 + diffY1a2 - diffZ1a2) * diffZi12) * 4.0 * d1a2 * diffZ1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (-diffX1a * diffY1a * diffXi1 * diffYi1 * 4.0 * d1a2 * diffZ1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (diffY1a * diffYi1 * (-2.0 * z1 + zi + za) * d1a4 - diffY1a * diffZ1a * diffYi1 * diffZi1 * 4.0 * d1a2 * diffZ1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (diffX1a * diffXi1 * (-2.0 * z1 + zi + za) * d1a4 - diffX1a * diffZ1a * diffXi1 * diffZi1 * 4.0 * d1a2 * diffZ1a) / d1a8;

                    // derivative of rssi respect to xa

                    // We have
                    // Pr(pi) = Pr(p1)
                    //   -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //   -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //   -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //   -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //   +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //   +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //   +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    // Hence
                    // diff(((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))/diff(xa) =
                    //   -(xi - x1)

                    // diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(xa) =
                    //   2*(x1 - xa)*(xi - x1)^2

                    // diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(xa) =
                    //   -2*(x1 - xa)*(yi - y1)^2

                    // diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(xa) =
                    //   -2*(x1 - xa)*(zi - z1)^2

                    // diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(xa) =
                    //   -(y1 - ya)*(xi - x1)*(yi - y1)

                    // diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(xa) = 0

                    // diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(xa) =
                    //   -(z1 - za)*(xi - x1)*(zi - z1)

                    // diff(Pr(pi))/diff(xa) = -10*n/ln(10)*(-(xi - x1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //   -5*n/ln(10)*(2*(x1 - xa)*(xi - x1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(-2*(x1 - xa)*(yi - y1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(-2*(x1 - xa)*(zi - z1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*(-(y1 - ya)*(xi - x1)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*(-(z1 - za)*(xi - x1)*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    // diff(Pr(pi))/diff(xa) = -10*n/ln(10)*(-(xi - x1)*d1a^2 + (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*2*(x1 - xa))/d1a^4
                    //   -5*n/ln(10)*(2*(x1 - xa)*(xi - x1)^2*d1a^4 + (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*4*d1a^2*(x1 - xa))/d1a^8
                    //   -5*n/ln(10)*(-2*(x1 - xa)*(yi - y1)^2*d1a^4 + (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*4*d1a^2*(x1 - xa))/d1a^8
                    //   -5*n/ln(10)*(-2*(x1 - xa)*(zi - z1)^2*d1a^4 + (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*4*d1a^2*(x1 - xa))/d1a^8
                    //   +20*n/ln(10)*(-(y1 - ya)*(xi - x1)*(yi - y1)*d1a^4 + (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(x1 - xa))/d1a^8
                    //   +20*n/ln(10)*((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*4*d1a^2*(x1 - xa))/d1a^8
                    //   +20*n/ln(10)*(-(z1 - za)*(xi - x1)*(zi - z1)*d1a^4 + (x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1)*4*d1a^2*(x1 - xa))/d1a^8
<span class="fc" id="L1558">                    final var derivativeXa = -10.0 * pathLossExponent / ln10 * (-diffXi1 * d1a2 + crossDiff * 2.0 * diffX1a) / d1a4</span>
                            - 5.0 * pathLossExponent / ln10 * (2.0 * diffX1a * diffXi12 * d1a4 + ((diffY1a2 + diffZ1a2 - diffX1a2) * diffXi12) * 4.0 * d1a2 * diffX1a) / d1a8
                            - 5.0 * pathLossExponent / ln10 * (-2.0 * diffX1a * diffYi12 * d1a4 + ((diffX1a2 - diffY1a2 + diffZ1a2) * diffYi12) * 4.0 * d1a2 * diffX1a) / d1a8
                            - 5.0 * pathLossExponent / ln10 * (-2.0 * diffX1a * diffZi12 * d1a4 + ((diffX1a2 + diffY1a2 - diffZ1a2) * diffZi12) * 4.0 * d1a2 * diffX1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (-diffY1a * diffXi1 * diffYi1 * d1a4 + tmp2) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (diffY1a * diffZ1a * diffYi1 * diffZi1 * 4.0 * d1a2 * diffX1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (-diffZ1a * diffXi1 * diffZi1 * d1a4 + tmp3) / d1a8;

                    // derivative of rssi respect to ya

                    // We have
                    // Pr(pi) = Pr(p1)
                    //   -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //   -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //   -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //   -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //   +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //   +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //   +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    // Hence
                    // diff(((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))/diff(ya) =
                    //   -(yi - y1)

                    // diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(ya) =
                    //   -2*(y1 - ya)*(xi - x1)^2

                    // diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(ya) =
                    //   2*(y1 - ya)*(yi - y1)^2

                    // diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(ya) =
                    //   -2*(y1 - ya)*(zi - z1)^2

                    // diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(ya) =
                    //   -(x1 - xa)*(xi - x1)*(yi - y1)

                    // diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(ya) =
                    //   -(z1 - za)*(yi - y1)*(zi - z1)

                    // diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(ya) = 0

                    // diff(Pr(pi))/diff(ya) = -10*n/ln(10)*(-(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //   -5*n/ln(10)*(-2*(y1 - ya)*(xi - x1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(2*(y1 - ya)*(yi - y1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(-2*(y1 - ya)*(zi - z1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*(-(x1 - xa)*(xi - x1)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*(-(z1 - za)*(yi - y1)*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    // diff(Pr(pi))/diff(ya) = -10*n/ln(10)*(-(yi - y1)*d1a^2 + (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*2*(y1 - ya))/d1a^4
                    //   -5*n/ln(10)*(-2*(y1 - ya)*(xi - x1)^2*d1a^4 + (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*4*d1a^2*(y1 - ya))/d1a^8
                    //   -5*n/ln(10)*(2*(y1 - ya)*(yi - y1)^2*d1a^4 + (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*4*d1a^2*(y1 - ya))/d1a^8
                    //   -5*n/ln(10)*(-2*(y1 - ya)*(zi - z1)^2*d1a^4 + (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*4*d1a^2*(y1 - ya))/d1a^8
                    //   +20*n/ln(10)*(-(x1 - xa)*(xi - x1)*(yi - y1)*d1a^4 + ((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))*4*d1a^2*(y1 - ya))/d1a^8
                    //   +20*n/ln(10)*(-(z1 - za)*(yi - y1)*(zi - z1)*d1a^4 + (y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*4*d1a^2*(y1 - ya))/d1a^8
                    //   +20*n/ln(10)*(((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*4*d1a^2*(y1 - ya))/d1a^8
<span class="fc" id="L1614">                    final var derivativeYa = -10.0 * pathLossExponent / ln10 * (-diffYi1 * d1a2 + crossDiff * 2.0 * diffY1a) / d1a4</span>
                            - 5.0 * pathLossExponent / ln10 * (-2.0 * diffY1a * diffXi12 * d1a4 + ((diffY1a2 + diffZ1a2 - diffX1a2) * diffXi12) * 4.0 * d1a2 * diffY1a) / d1a8
                            - 5.0 * pathLossExponent / ln10 * (2.0 * diffY1a * diffYi12 * d1a4 + ((diffX1a2 - diffY1a2 + diffZ1a2) * diffYi12) * 4.0 * d1a2 * diffY1a) / d1a8
                            - 5.0 * pathLossExponent / ln10 * (-2.0 * diffY1a * diffZi12 * d1a4 + ((diffX1a2 + diffY1a2 - diffZ1a2) * diffZi12) * 4.0 * d1a2 * diffY1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (-diffX1a * diffXi1 * diffYi1 * d1a4 + (diffX1a * diffY1a * diffXi1 * diffYi1) * 4.0 * d1a2 * diffY1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (-diffZ1a * diffYi1 * diffZi1 * d1a4 + tmp4) / d1a8
                            + 20.0 * pathLossExponent / ln10 * ((diffX1a * diffZ1a * diffXi1 * diffZi1) * 4.0 * d1a2 * diffY1a) / d1a8;

                    // derivative of rssi respect to za

                    // We have
                    // Pr(pi) = Pr(p1)
                    //   -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //   -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //   -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //   -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //   +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //   +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //   +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    // Hence
                    // diff(((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))/diff(za) =
                    //   -(zi - z1)

                    // diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(za) =
                    //   -2*(z1 - za)*(xi - x1)^2

                    // diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(za) =
                    //   -2*(z1 - za)*(yi - y1)^2

                    // diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(za) =
                    //   2*(z1 - za)*(zi - z1)^2

                    // diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(za) = 0

                    // diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(za) =
                    //   -(y1 - ya)*(yi - y1)*(zi - z1)

                    // diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(za) =
                    //   -(x1 - xa)*(xi - x1)*(zi - z1)

                    // diff(Pr(pi))/diff(za) = -10*n/ln(10)*(-(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //   -5*n/ln(10)*(-2*(z1 - za)*(xi - x1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(-2*(z1 - za)*(yi - y1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(2*(z1 - za)*(zi - z1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*(-(y1 - ya)*(yi - y1)*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*(-(x1 - xa)*(xi - x1)*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    // diff(Pr(pi))/diff(za) = -10*n/ln(10)*(-(zi - z1)*d1a^2 + (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*2*(z1 - za))/d1a^4
                    //   -5*n/ln(10)*(-2*(z1 - za)*(xi - x1)^2*d1a^4 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*4*d1a^2*(z1 - za))/d1a^8
                    //   -5*n/ln(10)*(-2*(z1 - za)*(yi - y1)^2*d1a^4 + (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*4*d1a^2*(z1 - za))/d1a^8
                    //   -5*n/ln(10)*(2*(z1 - za)*(zi - z1)^2*d1a^4 + (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*4*d1a^2*(z1 - za))/d1a^8
                    //   +20*n/ln(10)*(((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))*4*d1a^2*(z1 - za))/d1a^8
                    //   +20*n/ln(10)*(-(y1 - ya)*(yi - y1)*(zi - z1)*d1a^4 + ((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))*4*d1a^2*(z1 - za))/d1a^8
                    //   +20*n/ln(10)*(-(x1 - xa)*(xi - x1)*(zi - z1)*d1a^4 + ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*4*d1a^2*(z1 - za))/d1a^8
<span class="fc" id="L1670">                    final var derivativeZa = -10.0 * pathLossExponent / ln10 * (-diffZi1 * d1a2 + crossDiff * 2.0 * diffZ1a) / d1a4</span>
                            - 5.0 * pathLossExponent / ln10 * (-2.0 * diffZ1a * diffXi12 * d1a4 - (-diffX1a2 + diffY1a2 + diffZ1a2) * diffXi12 * 4.0 * d1a2 * diffZ1a) / d1a8
                            - 5.0 * pathLossExponent / ln10 * (-2.0 * diffZ1a * diffYi12 * d1a4 + (diffX1a2 - diffY1a2 + diffZ1a2) * diffYi12 * 4.0 * d1a2 * diffZ1a) / d1a8
                            - 5.0 * pathLossExponent / ln10 * (2.0 * diffZ1a * diffZi12 * d1a4 + (diffX1a2 + diffY1a2 - diffZ1a2) * diffZi12 * 4.0 * d1a2 * diffZ1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * ((diffX1a * diffY1a * diffXi1 * diffYi1) * 4.0 * d1a2 * diffZ1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (-diffY1a * diffYi1 * diffZi1 * d1a4 + (diffY1a * diffZ1a * diffYi1 * diffZi1) * 4.0 * d1a2 * diffZ1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (-diffX1a * diffXi1 * diffZi1 * d1a4 + (diffX1a * diffZ1a * diffXi1 * diffZi1) * 4.0 * d1a2 * diffZ1a) / d1a8;

                    // derivative of rssi respect to xi

                    // We have
                    // Pr(pi) = Pr(p1)
                    //   -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //   -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //   -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //   -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //   +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //   +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //   +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    // Hence
                    // diff(((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))/diff(xi) =
                    //   x1 - xa

                    // diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(xi) =
                    //   2*(xi - x1)*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)

                    // diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(xi) = 0

                    // diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(xi) = 0

                    // diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(xi) =
                    //   (x1 - xa)*(y1 - ya)*(yi - y1)

                    // diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(xi) = 0

                    // diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(xi) =
                    //   (x1 - xa)*(z1 - za)*(zi - z1)

                    // diff(Pr(pi))/diff(xi) = -10*n/ln(10)*((x1 - xa)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //   -5*n/ln(10)*(2*(xi - x1)*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*((x1 - xa)*(y1 - ya)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*((x1 - xa)*(z1 - za)*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    // diff(Pr(pi))/diff(xi) = -10*n/ln(10)*(x1 - xa)*d1a^2/d1a^4
                    //   -5*n/ln(10)*(2*(xi - x1)*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*d1a^4)/d1a^8
                    //   +20*n/ln(10)*(x1 - xa)*(y1 - ya)*(yi - y1)*d1a^4/d1a^8
                    //   +20*n/ln(10)*(x1 - xa)*(z1 - za)*(zi - z1)*d1a^4)/d1a^8

                    // diff(Pr(pi))/diff(xi) = -10*n/ln(10)*(x1 - xa)/d1a^2
                    //   -10*n/ln(10)*(xi - x1)*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/d1a^4
                    //   +20*n/ln(10)*(x1 - xa)*(y1 - ya)*(yi - y1)/d1a^4
                    //   +20*n/ln(10)*(x1 - xa)*(z1 - za)*(zi - z1)/d1a^4
<span class="fc" id="L1726">                    final var derivativeXi = -10.0 * pathLossExponent / ln10 * diffX1a / d1a2</span>
                            - 10.0 * pathLossExponent / ln10 * diffXi1 * (-diffX1a2 + diffY1a2 + diffZ1a2) / d1a4
                            + 20.0 * pathLossExponent / ln10 * diffX1a * diffY1a * diffYi1 / d1a4
                            + 20.0 * pathLossExponent / ln10 * diffX1a * diffZ1a * diffZi1 / d1a4;

                    // derivative of rssi respect to yi

                    // We have
                    // Pr(pi) = Pr(p1)
                    //   -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //   -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //   -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //   -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //   +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //   +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //   +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    // Hence
                    // diff(((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))/diff(yi) =
                    //   y1 - ya

                    // diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(yi) = 0

                    // diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(yi) =
                    //   2*(yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)

                    // diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(yi) = 0

                    // diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(yi) =
                    //   (x1 - xa)*(y1 - ya)*(xi - x1)

                    // diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(yi) =
                    //   (y1 - ya)*(z1 - za)*(zi - z1)

                    // diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(yi) = 0

                    // diff(Pr(pi))/diff(yi) = -10*n/ln(10)*((y1 - ya)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //   -5*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(2*(yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*((x1 - xa)*(y1 - ya)*(xi - x1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*((y1 - ya)*(z1 - za)*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    // diff(Pr(pi))/diff(yi) = -10*n/ln(10)*(y1 - ya)*d1a^2/d1a^4
                    //   -5*n/ln(10)*(2*(yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*d1a^4)/d1a^8
                    //   +20*n/ln(10)*((x1 - xa)*(y1 - ya)*(xi - x1)*d1a^4)/d1a^8
                    //   +20*n/ln(10)*((y1 - ya)*(z1 - za)*(zi - z1)*d1a^4)/d1a^8

                    // diff(Pr(pi))/diff(yi) = -10*n/ln(10)*(y1 - ya)/d1a^2
                    //   -10*n/ln(10)*(yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/d1a^4
                    //   +20*n/ln(10)*(x1 - xa)*(y1 - ya)*(xi - x1)/d1a^4
                    //   +20*n/ln(10)*(y1 - ya)*(z1 - za)*(zi - z1)/d1a^4
<span class="fc" id="L1779">                    final var derivativeYi = -10.0 * pathLossExponent / ln10 * diffY1a / d1a2</span>
                            - 10.0 * pathLossExponent / ln10 * diffYi1 * (diffX1a2 - diffY1a2 + diffZ1a2) / d1a4
                            + 20.0 * pathLossExponent / ln10 * diffX1a * diffY1a * diffXi1 / d1a4
                            + 20.0 * pathLossExponent / ln10 * diffY1a * diffZ1a * diffZi1 / d1a4;

                    // derivative of rssi respect to zi

                    // We have
                    // Pr(pi) = Pr(p1)
                    //   -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //   -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //   -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //   -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //   +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //   +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //   +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    // Hence
                    // diff(((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))/diff(zi) =
                    //   z1 - za

                    // diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(zi) = 0

                    // diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(zi) = 0

                    // diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(zi) =
                    //   2*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)

                    // diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(zi) = 0

                    // diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(zi) =
                    //   (y1 - ya)*(z1 - za)*(yi - y1)

                    // diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(zi) =
                    //   (x1 - xa)*(z1 - za)*(xi - x1)

                    // diff(Pr(pi))/diff(zi) = -10*n/ln(10)*((z1 - za)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //   -5*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   -5*n/ln(10)*(2*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   20*n/ln(10)*((y1 - ya)*(z1 - za)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //   20*n/ln(10)*((x1 - xa)*(z1 - za)*(xi - x1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    // diff(Pr(pi))/diff(zi) = -10*n/ln(10)*((z1 - za)*d1a^2)/d1a^4
                    //   -5*n/ln(10)*(2*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*d1a^4)/d1a^8
                    //   20*n/ln(10)*((y1 - ya)*(z1 - za)*(yi - y1)*d1a^4)/d1a^8
                    //   20*n/ln(10)*((x1 - xa)*(z1 - za)*(xi - x1)*d1a^4)/d1a^8

                    // diff(Pr(pi))/diff(zi) = -10*n/ln(10)*(z1 - za)/d1a^2
                    //   -10*n/ln(10)*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/d1a^4
                    //   20*n/ln(10)*(y1 - ya)*(z1 - za)*(yi - y1)/d1a^4
                    //   20*n/ln(10)*(x1 - xa)*(z1 - za)*(xi - x1)/d1a^4
<span class="fc" id="L1832">                    final var derivativeZi = -10.0 * pathLossExponent / ln10 * diffZ1a / d1a2</span>
                            - 10.0 * pathLossExponent / ln10 * diffZi1 * (diffX1a2 + diffY1a2 - diffZ1a2) / d1a4
                            + 20.0 * pathLossExponent / ln10 * diffY1a * diffZ1a * diffYi1 / d1a4
                            + 20.0 * pathLossExponent / ln10 * diffX1a * diffZ1a * diffXi1 / d1a4;

                    // set derivatives fingerprintRssi, pathLossExponent, x1, y1, z1, xa, ya, za, xi, yi, zi
<span class="fc" id="L1838">                    jacobian.setElementAtIndex(0, derivativeFingerprintRssi);</span>
<span class="fc" id="L1839">                    jacobian.setElementAtIndex(1, derivativePathLossExponent);</span>
<span class="fc" id="L1840">                    jacobian.setElementAtIndex(2, derivativeX1);</span>
<span class="fc" id="L1841">                    jacobian.setElementAtIndex(3, derivativeY1);</span>
<span class="fc" id="L1842">                    jacobian.setElementAtIndex(4, derivativeZ1);</span>
<span class="fc" id="L1843">                    jacobian.setElementAtIndex(5, derivativeXa);</span>
<span class="fc" id="L1844">                    jacobian.setElementAtIndex(6, derivativeYa);</span>
<span class="fc" id="L1845">                    jacobian.setElementAtIndex(7, derivativeZa);</span>
<span class="fc" id="L1846">                    jacobian.setElementAtIndex(8, derivativeXi);</span>
<span class="fc" id="L1847">                    jacobian.setElementAtIndex(9, derivativeYi);</span>
<span class="fc" id="L1848">                    jacobian.setElementAtIndex(10, derivativeZi);</span>
<span class="fc" id="L1849">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L1853">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L1856">        } catch (final AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L1857">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (fingerprint rssi variance, path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * rssi variance by considering the 2D 3rd order Taylor expression of received power.
     * Notice that any unknown variance is assumed to be zero.
     *
     * @param fingerprintRssi               closest located fingerprint reading RSSI expressed in dBm's.
     * @param pathLossExponent              path-loss exponent.
     * @param fingerprintPosition           position of closest fingerprint.
     * @param radioSourcePosition           radio source position associated to fingerprint reading.
     * @param estimatedPosition             position to be estimated. Usually this is equal to the
     *                                      initial position used by a non-linear algorithm.
     * @param fingerprintRssiVariance       variance of fingerprint RSSI or null if unknown.
     * @param pathLossExponentVariance      variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance   covariance of position to be estimated or null
     *                                      if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiVarianceThirdOrderNonLinear2D(
            final double fingerprintRssi, final double pathLossExponent,
            final Point2D fingerprintPosition, final Point2D radioSourcePosition,
            final Point2D estimatedPosition, final Double fingerprintRssiVariance,
            final Double pathLossExponentVariance,
            final Matrix fingerprintPositionCovariance,
            final Matrix radioSourcePositionCovariance,
            final Matrix estimatedPositionCovariance) throws IndoorException {

<span class="fc bfc" id="L1893" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null || estimatedPosition == null) {</span>
<span class="fc" id="L1894">            return null;</span>
        }

        // 3rd order Taylor expression of received power in 2D:
        // Pr(pi) = Pr(p1)
        //   -10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1) +
        //   -10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1) +
        //   -5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*d1a^4)*(xi - x1)^2 +
        //   -5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*d1a^4)*(yi - y1)^2 +
        //   20*n*(x1 - xa)*(y1 - ya)/(ln(10)*d1a^4)*(xi - x1)*(yi - y1) +
        //   -10/6*n/ln(10)*(-2*(x1 - xa)*dia^4 - ((y1 - ya)^2 - (x1 - xa)^2)*4*d1a^2*(x1 - xa))/d1a^8*(xi - x1)^3 +
        //   -10/6*n/ln(10)*(-2*(y1 - ya)*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2)*4*d1a^2*(y1 - ya))/d1a^8*(yi - y1)^3 +
        //   -5*n/ln(10)*(2*(y1 - ya)*d1a^4 - ((y1 - ya)^2 - (x1 - xa)^2)*4*d1a^2*(y1 - ya))/d1a^8*(xi - x1)^2*(yi - y1) +
        //   -5*n/ln(10)*(2*(x1 - xa)*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2)*4*d1a^2*(x1 - xa))/d1a^8*(xi - x1)*(yi - y1)^2
        // where d1a2 = (x1 - xa)^2 + (y1 - ya)^2

<span class="fc" id="L1910">        final var x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L1911">        final var y1 = fingerprintPosition.getInhomY();</span>

<span class="fc" id="L1913">        final var xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L1914">        final var ya = radioSourcePosition.getInhomY();</span>

<span class="fc" id="L1916">        final var xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L1917">        final var yi = estimatedPosition.getInhomY();</span>

<span class="fc" id="L1919">        final var mean = new double[]{</span>
                fingerprintRssi, pathLossExponent, x1, y1, xa, ya, xi, yi
        };
<span class="fc" id="L1922">        final var covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L1923" title="All 2 branches covered.">                fingerprintRssiVariance != null ? fingerprintRssiVariance : 0.0,</span>
<span class="fc bfc" id="L1924" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L1928" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null</span>
<span class="pc bpc" id="L1929" title="1 of 2 branches missed.">                &amp;&amp; fingerprintPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L1930" title="1 of 2 branches missed.">                &amp;&amp; fingerprintPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="fc" id="L1932">            covariance.setSubmatrix(2, 2, 3, 3,</span>
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L1936" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null</span>
<span class="pc bpc" id="L1937" title="1 of 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L1938" title="1 of 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L1939">            covariance.setSubmatrix(4, 4, 5, 5,</span>
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L1943" title="All 2 branches covered.">        if (estimatedPositionCovariance != null</span>
<span class="pc bpc" id="L1944" title="1 of 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L1945" title="1 of 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L1946">            covariance.setSubmatrix(6, 6, 7, 7,</span>
                    estimatedPositionCovariance);
        }

        try {
            // although less precise, we use a jacobian estimator to simplify expressions
<span class="fc" id="L1952">            final MultiVariateFunctionEvaluatorListener evaluator = new MultiVariateFunctionEvaluatorListener() {</span>
                @Override
                public void evaluate(final double[] point, final double[] result) {
                    // Pr(pi) = Pr(p1)
                    //   -10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    //   -10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
                    //   -5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*d1a^4)*(xi - x1)^2
                    //   -5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*d1a^4)*(yi - y1)^2
                    //   +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*d1a^4)*(xi - x1)*(yi - y1)
                    //   -10/6*n/ln(10)*(-2*(x1 - xa)*dia^4 - ((y1 - ya)^2 - (x1 - xa)^2)*4*d1a^2*(x1 - xa))/d1a^8*(xi - x1)^3
                    //   -10/6*n/ln(10)*(-2*(y1 - ya)*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2)*4*d1a^2*(y1 - ya))/d1a^8*(yi - y1)^3
                    //   -5*n/ln(10)*(2*(y1 - ya)*d1a^4 - ((y1 - ya)^2 - (x1 - xa)^2)*4*d1a^2*(y1 - ya))/d1a^8*(xi - x1)^2*(yi - y1)
                    //   -5*n/ln(10)*(2*(x1 - xa)*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2)*4*d1a^2*(x1 - xa))/d1a^8*(xi - x1)*(yi - y1)^2
                    // where d1a2 = (x1 - xa)^2 + (y1 - ya)^2

                    // Hence:
                    // Pr(pi) = Pr(p1)
                    //   -10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*(xi - x1)
                    //   -10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*(yi - y1)
                    //   -5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)*(xi - x1)^2
                    //   -5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)*(yi - y1)^2
                    //   +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)*(xi - x1)*(yi - y1)
                    //   -10/6*n/ln(10)*(-2*(x1 - xa)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((y1 - ya)^2 - (x1 - xa)^2)*4*((x1 - xa)^2 + (y1 - ya)^2)*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^4*(xi - x1)^3
                    //   -10/6*n/ln(10)*(-2*(y1 - ya)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*4*((x1 - xa)^2 + (y1 - ya)^2)*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^4*(yi - y1)^3
                    //   -5*n/ln(10)*(2*(y1 - ya)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((y1 - ya)^2 - (x1 - xa)^2)*4*((x1 - xa)^2 + (y1 - ya)^2)*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^4*(xi - x1)^2*(yi - y1)
                    //   -5*n/ln(10)*(2*(x1 - xa)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*4*((x1 - xa)^2 + (y1 - ya)^2)*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^4*(xi - x1)*(yi - y1)^2

<span class="fc" id="L1979">                    final var fingerprintRssi = point[0];</span>
<span class="fc" id="L1980">                    final var pathLossExponent = point[1];</span>
<span class="fc" id="L1981">                    final var x1 = point[2];</span>
<span class="fc" id="L1982">                    final var y1 = point[3];</span>
<span class="fc" id="L1983">                    final var xa = point[4];</span>
<span class="fc" id="L1984">                    final var ya = point[5];</span>
<span class="fc" id="L1985">                    final var xi = point[6];</span>
<span class="fc" id="L1986">                    final var yi = point[7];</span>

<span class="fc" id="L1988">                    final var diffX1a = x1 - xa;</span>
<span class="fc" id="L1989">                    final var diffY1a = y1 - ya;</span>

<span class="fc" id="L1991">                    final var diffXi1 = xi - x1;</span>
<span class="fc" id="L1992">                    final var diffYi1 = yi - y1;</span>

<span class="fc" id="L1994">                    final var diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L1995">                    final var diffY1a2 = diffY1a * diffY1a;</span>

<span class="fc" id="L1997">                    final var diffXi12 = diffXi1 * diffXi1;</span>
<span class="fc" id="L1998">                    final var diffYi12 = diffYi1 * diffYi1;</span>

<span class="fc" id="L2000">                    final var diffXi13 = diffXi12 * diffXi1;</span>
<span class="fc" id="L2001">                    final var diffYi13 = diffYi12 * diffYi1;</span>

<span class="fc" id="L2003">                    final var d1a2 = diffX1a2 + diffY1a2;</span>
<span class="fc" id="L2004">                    final var d1a4 = d1a2 * d1a2;</span>
<span class="fc" id="L2005">                    final var d1a8 = d1a4 * d1a4;</span>

<span class="fc" id="L2007">                    final var ln10 = Math.log(10.0);</span>

<span class="fc" id="L2009">                    result[0] = fingerprintRssi</span>
                            - 10.0 * pathLossExponent * diffX1a / (ln10 * d1a2) * diffXi1
                            - 10.0 * pathLossExponent * diffY1a / (ln10 * d1a2) * diffYi1
                            - 5.0 * pathLossExponent * (-diffX1a2 + diffY1a2) / (ln10 * d1a4) * diffXi12
                            - 5.0 * pathLossExponent * (diffX1a2 - diffY1a2) / (ln10 * d1a4) * diffYi12
                            + 20.0 * pathLossExponent * diffX1a * diffY1a / (ln10 * d1a4) * diffXi1 * diffYi1
                            - 10.0 / 6.0 * pathLossExponent / ln10 * (-2.0 * diffX1a * d1a4 - (-diffX1a2 + diffY1a2) * 4.0 * d1a2 * diffX1a) / d1a8 * diffXi13
                            - 10.0 / 6.0 * pathLossExponent / ln10 * (-2.0 * diffY1a * d1a4 - (diffX1a2 - diffY1a2) * 4.0 * d1a2 * diffY1a) / d1a8 * diffYi13
                            - 5.0 * pathLossExponent / ln10 * (2.0 * diffY1a * d1a4 - (-diffX1a2 + diffY1a2) * 4.0 * d1a2 * diffY1a) / d1a8 * diffXi12 * diffYi1
                            - 5.0 * pathLossExponent / ln10 * (2.0 * diffX1a * d1a4 - (diffX1a2 - diffY1a2) * 4.0 * d1a2 * diffX1a) / d1a8 * diffXi1 * diffYi12;
<span class="fc" id="L2019">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L2023">                    return 1;</span>
                }
            };

<span class="fc" id="L2027">            final var jacobianEstimator = new JacobianEstimator(evaluator);</span>

<span class="fc" id="L2029">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(final double[] x, final double[] y, final Matrix jacobian) {

                    try {
<span class="fc" id="L2034">                        evaluator.evaluate(x, y);</span>
<span class="fc" id="L2035">                        jacobianEstimator.jacobian(x, jacobian);</span>
<span class="nc" id="L2036">                    } catch (final EvaluationException ignore) {</span>
                        //never happens
<span class="fc" id="L2038">                    }</span>
<span class="fc" id="L2039">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L2043">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L2046">        } catch (final AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L2047">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (fingerprint rssi variance, path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * rssi variance by considering the 3D 3rd order Taylor expression of received power.
     * Notice that any unknown variance is assumed to be zero.
     *
     * @param fingerprintRssi               closest located fingerprint reading RSSI expressed in dBm's.
     * @param pathLossExponent              path-loss exponent.
     * @param fingerprintPosition           position of closest fingerprint.
     * @param radioSourcePosition           radio source position associated to fingerprint reading.
     * @param estimatedPosition             position to be estimated. Usually this is equal to the
     *                                      initial position used by a non-linear algorithm.
     * @param fingerprintRssiVariance       variance of fingerprint RSSI or null if unknown.
     * @param pathLossExponentVariance      variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance   covariance of position to be estimated or null
     *                                      if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiVarianceThirdOrderNonLinear3D(
            final double fingerprintRssi, final double pathLossExponent, final Point3D fingerprintPosition,
            final Point3D radioSourcePosition, final Point3D estimatedPosition, final Double fingerprintRssiVariance,
            final Double pathLossExponentVariance, final Matrix fingerprintPositionCovariance,
            final Matrix radioSourcePositionCovariance, final Matrix estimatedPositionCovariance)
            throws IndoorException {

<span class="fc bfc" id="L2081" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null || estimatedPosition == null) {</span>
<span class="fc" id="L2082">            return null;</span>
        }

        // 1st order Taylor expression of received power in 3D:
        // Pr(pi) = Pr(p1)
        //   - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
        //   - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
        //   - 10*n*(z1 - za)/(ln(10)*d1a^2)*(zi - z1)
        // where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2

<span class="fc" id="L2092">        final var x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L2093">        final var y1 = fingerprintPosition.getInhomY();</span>
<span class="fc" id="L2094">        final var z1 = fingerprintPosition.getInhomZ();</span>

<span class="fc" id="L2096">        final var xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L2097">        final var ya = radioSourcePosition.getInhomY();</span>
<span class="fc" id="L2098">        final var za = radioSourcePosition.getInhomZ();</span>

<span class="fc" id="L2100">        final var xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L2101">        final var yi = estimatedPosition.getInhomY();</span>
<span class="fc" id="L2102">        final var zi = estimatedPosition.getInhomZ();</span>

<span class="fc" id="L2104">        final var mean = new double[]{</span>
                fingerprintRssi, pathLossExponent, x1, y1, z1, xa, ya, za, xi, yi, zi
        };
<span class="fc" id="L2107">        final var covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L2108" title="All 2 branches covered.">                fingerprintRssiVariance != null ? fingerprintRssiVariance : 0.0,</span>
<span class="fc bfc" id="L2109" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L2113" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null</span>
<span class="pc bpc" id="L2114" title="1 of 2 branches missed.">                &amp;&amp; fingerprintPositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L2115" title="1 of 2 branches missed.">                &amp;&amp; fingerprintPositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="fc" id="L2117">            covariance.setSubmatrix(2, 2, 4, 4,</span>
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L2121" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null</span>
<span class="pc bpc" id="L2122" title="1 of 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L2123" title="1 of 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L2124">            covariance.setSubmatrix(5, 5, 7, 7,</span>
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L2128" title="All 2 branches covered.">        if (estimatedPositionCovariance != null</span>
<span class="pc bpc" id="L2129" title="1 of 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L2130" title="1 of 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L2131">            covariance.setSubmatrix(8, 8, 10, 10,</span>
                    estimatedPositionCovariance);
        }

        try {
            //although less precise, we use a jacobian estimator to simplify expressions
<span class="fc" id="L2137">            final MultiVariateFunctionEvaluatorListener evaluator = new MultiVariateFunctionEvaluatorListener() {</span>
                @Override
                public void evaluate(final double[] point, final double[] result) {
                    // Pr(pi = (xi,yi)) = Pr(p1) +
                    //   -10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1) +
                    //   -10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1) +
                    //   -10*n*(z1 - za)/(ln(10)*d1a^2)*(zi - z1) +
                    //   -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*d1a^4)*(xi - x1)^2 +
                    //   -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*d1a^4)*(yi - y1)^2 +
                    //   -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*d1a^4)*(zi - z1)^2 +
                    //   20*n*(x1 - xa)*(y1 - ya)/(ln(10)*d1a^4)*(xi - x1)*(yi - y1) +
                    //   20*n*(y1 - ya)*(z1 - za)/(ln(10)*d1a^4)*(yi - y1)*(zi - z1) +
                    //   20*n*(x1 - xa)*(z1 - za)/(ln(10)*d1a^4)*(xi - x1)*(zi - z1) +
                    //   -10/6*n/ln(10)*(-2*(x1 - xa)*d1a^4 - ((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*4*d1a^2*(x1 - xa))/d1a^8*(xi - x1)^3 +
                    //   -10/6*n/ln(10)*(-2*(y1 - ya)*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*4*d1a^2*(y1 - ya))/d1a^8*(yi - y1)^3 +
                    //   -10/6*n/ln(10)*(-2*(z1 - za)*d1a^4 - ((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*4*d1a^2*(z1 - za))/d1a^8*(zi - z1)^3 +
                    //   -5*n/ln(10)*(2*(y1 - ya)*d1a^4 - ((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*4*d1a^2*(y1 - ya))/d1a^8*(xi - x1)^2*(yi - y1) +
                    //   -5*n/ln(10)*(2*(z1 - za)*d1a^4 - ((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*4*d1a^2*(z1 - za))/d1a^8*(xi - x1)^2*(zi - z1) +
                    //   -5*n/ln(10)*(2*(x1 - xa)*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*4*d1a^2*(x1 - xa))/d1a^8*(xi - x1)*(yi - y1)^2 +
                    //   -5*n/ln(10)*(2*(x1 - xa)*d1a^4 - ((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*4*d1a^2*(x1 - xa))/d1a^8*(xi - x1)*(zi - z1)^2 +
                    //   -5*n/ln(10)*(2*(z1 - za)*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*4*d1a^2*(z1 - za))/d1a^8*(yi - y1)^2*(zi - z1) +
                    //   -5*n/ln(10)*(2*(y1 - ya)*d1a^4 - ((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*4*d1a^2*(y1 - ya))/d1a^8*(yi - y1)*(zi - z1)^2 +
                    //   -80*n/ln(10)*((x1 - xa)*(y1 - ya)*(z1 - za)*d1a^2)/d1a^8*(xi - x1)*(yi - y1)*(zi - z1)

<span class="fc" id="L2161">                    final var fingerprintRssi = point[0];</span>
<span class="fc" id="L2162">                    final var pathLossExponent = point[1];</span>
<span class="fc" id="L2163">                    final var x1 = point[2];</span>
<span class="fc" id="L2164">                    final var y1 = point[3];</span>
<span class="fc" id="L2165">                    final var z1 = point[4];</span>
<span class="fc" id="L2166">                    final var xa = point[5];</span>
<span class="fc" id="L2167">                    final var ya = point[6];</span>
<span class="fc" id="L2168">                    final var za = point[7];</span>
<span class="fc" id="L2169">                    final var xi = point[8];</span>
<span class="fc" id="L2170">                    final var yi = point[9];</span>
<span class="fc" id="L2171">                    final var zi = point[10];</span>

<span class="fc" id="L2173">                    final var diffX1a = x1 - xa;</span>
<span class="fc" id="L2174">                    final var diffY1a = y1 - ya;</span>
<span class="fc" id="L2175">                    final var diffZ1a = z1 - za;</span>

<span class="fc" id="L2177">                    final var diffXi1 = xi - x1;</span>
<span class="fc" id="L2178">                    final var diffYi1 = yi - y1;</span>
<span class="fc" id="L2179">                    final var diffZi1 = zi - z1;</span>

<span class="fc" id="L2181">                    final var diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L2182">                    final var diffY1a2 = diffY1a * diffY1a;</span>
<span class="fc" id="L2183">                    final var diffZ1a2 = diffZ1a * diffZ1a;</span>

<span class="fc" id="L2185">                    final var diffXi12 = diffXi1 * diffXi1;</span>
<span class="fc" id="L2186">                    final var diffYi12 = diffYi1 * diffYi1;</span>
<span class="fc" id="L2187">                    final var diffZi12 = diffZi1 * diffZi1;</span>

<span class="fc" id="L2189">                    final var diffXi13 = diffXi12 * diffXi1;</span>
<span class="fc" id="L2190">                    final var diffYi13 = diffYi12 * diffYi1;</span>
<span class="fc" id="L2191">                    final var diffZi13 = diffZi12 * diffZi1;</span>

<span class="fc" id="L2193">                    final var d1a2 = diffX1a2 + diffY1a2 + diffZ1a2;</span>
<span class="fc" id="L2194">                    final var d1a4 = d1a2 * d1a2;</span>
<span class="fc" id="L2195">                    final var d1a8 = d1a4 * d1a4;</span>

<span class="fc" id="L2197">                    final var ln10 = Math.log(10.0);</span>

<span class="fc" id="L2199">                    final var value1 = -10.0 * pathLossExponent * diffX1a / (ln10 * d1a2);</span>
<span class="fc" id="L2200">                    final var value2 = -10.0 * pathLossExponent * diffY1a / (ln10 * d1a2);</span>
<span class="fc" id="L2201">                    final var value3 = -10.0 * pathLossExponent * diffZ1a / (ln10 * d1a2);</span>
<span class="fc" id="L2202">                    final var value4 = -5.0 * pathLossExponent * (-diffX1a2 + diffY1a2 + diffZ1a2) / (ln10 * d1a4);</span>
<span class="fc" id="L2203">                    final var value5 = -5.0 * pathLossExponent * (diffX1a2 - diffY1a2 + diffZ1a2) / (ln10 * d1a4);</span>
<span class="fc" id="L2204">                    final var value6 = -5.0 * pathLossExponent * (diffX1a2 + diffY1a2 - diffZ1a2) / (ln10 * d1a4);</span>
<span class="fc" id="L2205">                    final var value7 = 20.0 * pathLossExponent * diffX1a * diffY1a / (ln10 * d1a4);</span>
<span class="fc" id="L2206">                    final var value8 = 20.0 * pathLossExponent * diffY1a * diffZ1a / (ln10 * d1a4);</span>
<span class="fc" id="L2207">                    final var value9 = 20.0 * pathLossExponent * diffX1a * diffZ1a / (ln10 * d1a4);</span>
<span class="fc" id="L2208">                    final var value10 = -10.0 / 6.0 * pathLossExponent / ln10 * (-2.0 * diffX1a * d1a4 - (-diffX1a2 + diffY1a2 + diffZ1a2) * 4.0 * d1a2 * diffX1a) / d1a8;</span>
<span class="fc" id="L2209">                    final var value11 = -10.0 / 6.0 * pathLossExponent / ln10 * (-2.0 * diffY1a * d1a4 - (diffX1a2 - diffY1a2 + diffZ1a2) * 4.0 * d1a2 * diffY1a) / d1a8;</span>
<span class="fc" id="L2210">                    final var value12 = -10.0 / 6.0 * pathLossExponent / ln10 * (-2.0 * diffZ1a * d1a4 - (diffX1a2 + diffY1a2 - diffZ1a2) * 4.0 * d1a2 * diffZ1a) / d1a8;</span>
<span class="fc" id="L2211">                    final var value13 = -5.0 * pathLossExponent / ln10 * (2.0 * diffY1a * d1a4 - (-diffX1a2 + diffY1a2 + diffZ1a2) * 4.0 * d1a2 * diffY1a) / d1a8;</span>
<span class="fc" id="L2212">                    final var value14 = -5.0 * pathLossExponent / ln10 * (2.0 * diffZ1a * d1a4 - (-diffX1a2 + diffY1a2 + diffZ1a2) * 4.0 * d1a2 * diffZ1a) / d1a8;</span>
<span class="fc" id="L2213">                    final var value15 = -5.0 * pathLossExponent / ln10 * (2.0 * diffX1a * d1a4 - (diffX1a2 - diffY1a2 + diffZ1a2) * 4.0 * d1a2 * diffX1a) / d1a8;</span>
<span class="fc" id="L2214">                    final var value16 = -5.0 * pathLossExponent / ln10 * (2.0 * diffX1a * d1a4 - (diffX1a2 + diffY1a2 - diffZ1a2) * 4.0 * d1a2 * diffX1a) / d1a8;</span>
<span class="fc" id="L2215">                    final var value17 = -5.0 * pathLossExponent / ln10 * (2.0 * diffZ1a * d1a4 - (diffX1a2 - diffY1a2 + diffZ1a2) * 4.0 * d1a2 * diffZ1a) / d1a8;</span>
<span class="fc" id="L2216">                    final var value18 = -5.0 * pathLossExponent / ln10 * (2.0 * diffY1a * d1a4 - (diffX1a2 + diffY1a2 - diffZ1a2) * 4.0 * d1a2 * diffY1a) / d1a8;</span>
<span class="fc" id="L2217">                    final var value19 = -80.0 * pathLossExponent / ln10 * (diffX1a * diffY1a * diffZ1a * d1a2) / d1a8;</span>

<span class="fc" id="L2219">                    result[0] = fingerprintRssi</span>
                            + value1 * diffXi1
                            + value2 * diffYi1
                            + value3 * diffZi1
                            + value4 * diffXi12
                            + value5 * diffYi12
                            + value6 * diffZi12
                            + value7 * diffXi1 * diffYi1
                            + value8 * diffYi1 * diffZi1
                            + value9 * diffXi1 * diffZi1
                            + value10 * diffXi13
                            + value11 * diffYi13
                            + value12 * diffZi13
                            + value13 * diffXi12 * diffYi1
                            + value14 * diffXi12 * diffZi1
                            + value15 * diffXi1 * diffYi12
                            + value16 * diffXi1 * diffZi12
                            + value17 * diffYi12 * diffZi1
                            + value18 * diffYi1 * diffZi12
                            + value19 * diffXi1 * diffYi1 * diffZi1;
<span class="fc" id="L2239">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L2243">                    return 1;</span>
                }
            };

<span class="fc" id="L2247">            final var jacobianEstimator = new JacobianEstimator(evaluator);</span>

<span class="fc" id="L2249">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(final double[] x, final double[] y, final Matrix jacobian) {

                    try {
<span class="fc" id="L2254">                        evaluator.evaluate(x, y);</span>
<span class="fc" id="L2255">                        jacobianEstimator.jacobian(x, jacobian);</span>
<span class="nc" id="L2256">                    } catch (final EvaluationException ignore) {</span>
                        //never happens
<span class="fc" id="L2258">                    }</span>
<span class="fc" id="L2259">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L2263">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L2266">        } catch (final AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L2267">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * difference of rssi variance by considering the 2D expression.
     * Notice that any unknown variance is assumed to be zero.
     *
     * @param pathLossExponent              path-loss exponent.
     * @param fingerprintPosition           position of closest fingerprint.
     * @param radioSourcePosition           radio source position associated to fingerprint reading.
     * @param estimatedPosition             position to be estimated. Usually this is equal to the
     *                                      initial position used by a non-linear algorithm.
     * @param pathLossExponentVariance      variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance   covariance of position to be estimated or null
     *                                      if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiDifferenceVariance2D(
            final double pathLossExponent, final Point2D fingerprintPosition, final Point2D radioSourcePosition,
            final Point2D estimatedPosition, final Double pathLossExponentVariance,
            final Matrix fingerprintPositionCovariance, final Matrix radioSourcePositionCovariance,
            final Matrix estimatedPositionCovariance) throws IndoorException {

<span class="fc bfc" id="L2298" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null || estimatedPosition == null) {</span>
<span class="fc" id="L2299">            return null;</span>
        }

        // Expression being used is:
        // Prdiff1a = Pr(pi) - Pr(p1) = 5*n*log(d1a^2) - 5*n*log(dia^2) =
        //   = 5*n*log((x1 - xa)^2 + (y1 - ya)^2) - 5*n*log((xi - xa)^2 + (yi - ya)^2)

<span class="fc" id="L2306">        final var x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L2307">        final var y1 = fingerprintPosition.getInhomY();</span>

<span class="fc" id="L2309">        final var xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L2310">        final var ya = radioSourcePosition.getInhomY();</span>

<span class="fc" id="L2312">        final var xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L2313">        final var yi = estimatedPosition.getInhomY();</span>

<span class="fc" id="L2315">        final var mean = new double[]{</span>
                pathLossExponent, x1, y1, xa, ya, xi, yi
        };
<span class="fc" id="L2318">        final var covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L2319" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L2323" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null</span>
<span class="pc bpc" id="L2324" title="1 of 2 branches missed.">                &amp;&amp; fingerprintPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L2325" title="1 of 2 branches missed.">                &amp;&amp; fingerprintPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="fc" id="L2327">            covariance.setSubmatrix(1, 1, 2, 2,</span>
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L2331" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null</span>
<span class="pc bpc" id="L2332" title="1 of 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L2333" title="1 of 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L2334">            covariance.setSubmatrix(3, 3, 4, 4,</span>
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L2338" title="All 2 branches covered.">        if (estimatedPositionCovariance != null</span>
<span class="pc bpc" id="L2339" title="1 of 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="pc bpc" id="L2340" title="1 of 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L2341">            covariance.setSubmatrix(5, 5, 6, 6,</span>
                    estimatedPositionCovariance);
        }

        try {
<span class="fc" id="L2346">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(final double[] x, final double[] y, final Matrix jacobian) {

                    // Expression being used is:
                    // Prdiff1a = Pr(pi) - Pr(p1) = 5*n*log(d1a^2) - 5*n*log(dia^2) =
                    //   = 5*n*log((x1 - xa)^2 + (y1 - ya)^2) - 5*n*log((xi - xa)^2 + (yi - ya)^2)

<span class="fc" id="L2354">                    final var diffX1a = x1 - xa;</span>
<span class="fc" id="L2355">                    final var diffY1a = y1 - ya;</span>

<span class="fc" id="L2357">                    final var diffXia = xi - xa;</span>
<span class="fc" id="L2358">                    final var diffYia = yi - ya;</span>

<span class="fc" id="L2360">                    final var diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L2361">                    final var diffY1a2 = diffY1a * diffY1a;</span>

<span class="fc" id="L2363">                    final var diffXia2 = diffXia * diffXia;</span>
<span class="fc" id="L2364">                    final var diffYia2 = diffYia * diffYia;</span>

<span class="fc" id="L2366">                    final var d1a2 = diffX1a2 + diffY1a2;</span>
<span class="fc" id="L2367">                    final var dia2 = diffXia2 + diffYia2;</span>

<span class="fc" id="L2369">                    final var ln10 = Math.log(10.0);</span>

                    // compute gradient (is a jacobian having 1 row and 7 columns)

                    // derivative of diff rssi respect to fingerprint path-loss exponent &quot;n&quot;

<span class="fc" id="L2375">                    final var derivativePathLossExponent = 5.0 * (Math.log10(d1a2) - Math.log10(dia2));</span>

                    // derivative of diff rssi respect to x1
                    // diff(Prdiff1a)/diff(x1) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*2*(x1 - xa) =
                    //   = 10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))

<span class="fc" id="L2381">                    final var tmp1a = 10.0 * pathLossExponent / (ln10 * d1a2);</span>
<span class="fc" id="L2382">                    final var derivativeX1 = tmp1a * diffX1a;</span>

                    // derivative of diff rssi respect to y1
                    // diff(Prdiff1a)/diff(y1) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*2*(y1 - ya) =
                    //   = 10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))

<span class="fc" id="L2388">                    final var derivativeY1 = tmp1a * diffY1a;</span>

                    // derivative of rssi respect to xi
                    // diff(Prdiff1a)/diff(xi) = -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2))*2*(xi - xa)
                    //   = -10*n*(xi - xa)/(ln(10)*((xi - xa)^2 + (yi - ya)^2))

<span class="fc" id="L2394">                    final var tmpia = 10.0 * pathLossExponent / (ln10 * dia2);</span>
<span class="fc" id="L2395">                    final var derivativeXi = -tmpia * diffXia;</span>

                    // derivative of rssi respect to yi
                    // diff(Prdiff1a)/diff(yi) = -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2))*2*(yi - ya)
                    //   = -10*n*(yi - ya)/(ln(10)*((xi - xa)^2 + (yi - ya)^2))

<span class="fc" id="L2401">                    final var derivativeYi = -tmpia * diffYia;</span>

                    // derivative of rssi respect to xa
                    // diff(Prdiff1a)/diff(xa) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*-2*(x1 - xa) -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2))*-2(xi - xa) =
                    //   = -10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)) + 10*n*(xi - xa)/(ln(10)*((xi - xa)^2 + (yi - ya)^2))

<span class="fc" id="L2407">                    final var derivativeXa = -derivativeX1 - derivativeXi;</span>

                    // derivative of rssi respect to ya
                    // diff(Prdiff1a)/diff(ya) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*-2*(y1 - ya) -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2))*-2(yi - ya) =
                    //   = -10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)) + 10*n*(yi - ya)/(ln(10)*((xi - xa)^2 + (yi - ya)^2))

<span class="fc" id="L2413">                    final var derivativeYa = -derivativeY1 - derivativeYi;</span>

                    // Prdiff1a = Pr(pi) - Pr(p1) = 5*n*log(d1a^2) - 5*n*log(dia^2) =
                    //   = 5*n*log((x1 - xa)^2 + (y1 - ya)^2) - 5*n*log((xi - xa)^2 + (yi - ya)^2)

                    // set derivatives pathLossExponent, x1, y1, xa, ya, xi, yi
<span class="fc" id="L2419">                    jacobian.setElementAtIndex(0, derivativePathLossExponent);</span>
<span class="fc" id="L2420">                    jacobian.setElementAtIndex(1, derivativeX1);</span>
<span class="fc" id="L2421">                    jacobian.setElementAtIndex(2, derivativeY1);</span>
<span class="fc" id="L2422">                    jacobian.setElementAtIndex(3, derivativeXa);</span>
<span class="fc" id="L2423">                    jacobian.setElementAtIndex(4, derivativeYa);</span>
<span class="fc" id="L2424">                    jacobian.setElementAtIndex(5, derivativeXi);</span>
<span class="fc" id="L2425">                    jacobian.setElementAtIndex(6, derivativeYi);</span>


<span class="fc" id="L2428">                    y[0] = derivativePathLossExponent * pathLossExponent;</span>
<span class="fc" id="L2429">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L2433">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L2436">        } catch (final AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L2437">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * difference of rssi variance by considering the 3D expression.
     * Notice that any unknown variance is assumed to be zero.
     *
     * @param pathLossExponent              path-loss exponent.
     * @param fingerprintPosition           position of closest fingerprint.
     * @param radioSourcePosition           radio source position associated to fingerprint reading.
     * @param estimatedPosition             position to be estimated. Usually this is equal to the
     *                                      initial position used by a non-linear algorithm.
     * @param pathLossExponentVariance      variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance   covariance of position to be estimated or null
     *                                      if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiDifferenceVariance3D(
            final double pathLossExponent, final Point3D fingerprintPosition, final Point3D radioSourcePosition,
            final Point3D estimatedPosition, final Double pathLossExponentVariance,
            final Matrix fingerprintPositionCovariance, final Matrix radioSourcePositionCovariance,
            final Matrix estimatedPositionCovariance) throws IndoorException {

<span class="fc bfc" id="L2468" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null || estimatedPosition == null) {</span>
<span class="fc" id="L2469">            return null;</span>
        }

        // Expression being used is:
        // Prdiff1a = Pr(pi) - Pr(p1) = 5*n*log(d1a^2) - 5*n*log(dia^2) =
        //   = 5*n*log((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - 5*n*log((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2)

<span class="fc" id="L2476">        final var x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L2477">        final var y1 = fingerprintPosition.getInhomY();</span>
<span class="fc" id="L2478">        final var z1 = fingerprintPosition.getInhomZ();</span>

<span class="fc" id="L2480">        final var xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L2481">        final var ya = radioSourcePosition.getInhomY();</span>
<span class="fc" id="L2482">        final var za = radioSourcePosition.getInhomZ();</span>

<span class="fc" id="L2484">        final var xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L2485">        final var yi = estimatedPosition.getInhomY();</span>
<span class="fc" id="L2486">        final var zi = estimatedPosition.getInhomZ();</span>

<span class="fc" id="L2488">        final var mean = new double[]{</span>
                pathLossExponent, x1, y1, z1, xa, ya, za, xi, yi, zi
        };
<span class="fc" id="L2491">        final var covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L2492" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L2496" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null</span>
<span class="pc bpc" id="L2497" title="1 of 2 branches missed.">                &amp;&amp; fingerprintPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="nc bnc" id="L2498" title="All 2 branches missed.">                &amp;&amp; fingerprintPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="nc" id="L2500">            covariance.setSubmatrix(1, 1, 3, 3,</span>
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L2504" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null</span>
<span class="pc bpc" id="L2505" title="1 of 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="nc bnc" id="L2506" title="All 2 branches missed.">                &amp;&amp; radioSourcePositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="nc" id="L2507">            covariance.setSubmatrix(4, 4, 6, 6,</span>
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L2511" title="All 2 branches covered.">        if (estimatedPositionCovariance != null</span>
<span class="pc bpc" id="L2512" title="1 of 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH</span>
<span class="nc bnc" id="L2513" title="All 2 branches missed.">                &amp;&amp; estimatedPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="nc" id="L2514">            covariance.setSubmatrix(7, 7, 9, 9,</span>
                    estimatedPositionCovariance);
        }

        try {
<span class="fc" id="L2519">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(final double[] x, final double[] y, final Matrix jacobian) {

                    // Expression being used is:
                    // Prdiff1a = Pr(pi) - Pr(p1) = 5*n*log(d1a^2) - 5*n*log(dia^2) =
                    //   = 5*n*log((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - 5*n*log((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2)

<span class="fc" id="L2527">                    final var diffX1a = x1 - xa;</span>
<span class="fc" id="L2528">                    final var diffY1a = y1 - ya;</span>
<span class="fc" id="L2529">                    final var diffZ1a = z1 - za;</span>

<span class="fc" id="L2531">                    final var diffXia = xi - xa;</span>
<span class="fc" id="L2532">                    final var diffYia = yi - ya;</span>
<span class="fc" id="L2533">                    final var diffZia = zi - za;</span>

<span class="fc" id="L2535">                    final var diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L2536">                    final var diffY1a2 = diffY1a * diffY1a;</span>
<span class="fc" id="L2537">                    final var diffZ1a2 = diffZ1a * diffZ1a;</span>

<span class="fc" id="L2539">                    final var diffXia2 = diffXia * diffXia;</span>
<span class="fc" id="L2540">                    final var diffYia2 = diffYia * diffYia;</span>
<span class="fc" id="L2541">                    final var diffZia2 = diffZia * diffZia;</span>

<span class="fc" id="L2543">                    final var d1a2 = diffX1a2 + diffY1a2 + diffZ1a2;</span>
<span class="fc" id="L2544">                    final var dia2 = diffXia2 + diffYia2 + diffZia2;</span>

<span class="fc" id="L2546">                    final var ln10 = Math.log(10.0);</span>

                    // compute gradient (is a jacobian having 1 row and 10 columns)

                    // derivative of diff rssi respect to fingerprint path-loss exponent &quot;n&quot;

<span class="fc" id="L2552">                    final var derivativePathLossExponent = 5.0 * (Math.log10(d1a2) - Math.log10(dia2));</span>

                    // derivative of diff rssi respect to x1
                    // diff(Prdiff1a)/diff(x1) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*2*(x1 - xa) =
                    //   = 10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

<span class="fc" id="L2558">                    final var tmp1a = 10.0 * pathLossExponent / (ln10 * d1a2);</span>
<span class="fc" id="L2559">                    final var derivativeX1 = tmp1a * diffX1a;</span>

                    // derivative of diff rssi respect to y1
                    // diff(Prdiff1a)/diff(y1) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2) + (z1 - za)^2)*2*(y1 - ya) =
                    //   = 10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

<span class="fc" id="L2565">                    final var derivativeY1 = tmp1a * diffY1a;</span>

                    // derivative of diff rssi respect to z1
                    // diff(Prdiff1a)/diff(z1) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2) + (z1 - za)^2)*2*(z1 - za) =
                    //   = 10*n*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

<span class="fc" id="L2571">                    final var derivativeZ1 = tmp1a * diffZ1a;</span>

                    // derivative of rssi respect to xi
                    // diff(Prdiff1a)/diff(xi) = -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))*2*(xi - xa)
                    //   = -10*n*(xi - xa)/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))

<span class="fc" id="L2577">                    final var tmpia = 10.0 * pathLossExponent / (ln10 * dia2);</span>
<span class="fc" id="L2578">                    final var derivativeXi = -tmpia * diffXia;</span>

                    // derivative of rssi respect to yi
                    // diff(Prdiff1a)/diff(yi) = -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))*2*(yi - ya)
                    //   = -10*n*(yi - ya)/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))

<span class="fc" id="L2584">                    final var derivativeYi = -tmpia * diffYia;</span>

                    // derivative of rssi respect to zi
                    // diff(Prdiff1a)/diff(zi) = -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))*2*(zi - za)
                    //   = -10*n*(zi - za)/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))

<span class="fc" id="L2590">                    final var derivativeZi = -tmpia * diffZia;</span>

                    // Prdiff1a = Pr(pi) - Pr(p1) = 5*n*log(d1a^2) - 5*n*log(dia^2) =
                    //   = 5*n*log((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - 5*n*log((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2)

                    // derivative of rssi respect to xa
                    // diff(Prdiff1a)/diff(xa) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*-2*(x1 - xa) -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))*-2(xi - xa) =
                    //   = -10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)) + 10*n*(xi - xa)/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))

<span class="fc" id="L2599">                    final var derivativeXa = -derivativeX1 - derivativeXi;</span>

                    // derivative of rssi respect to ya
                    // diff(Prdiff1a)/diff(ya) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*-2*(y1 - ya) -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))*-2(yi - ya) =
                    //   = -10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)) + 10*n*(yi - ya)/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))

<span class="fc" id="L2605">                    final var derivativeYa = -derivativeY1 - derivativeYi;</span>

                    // derivative of rssi respect to za
                    // diff(Prdiff1a)/diff(za) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*-2*(z1 - za) -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))*-2(zi - za) =
                    //   = -10*n*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)) + 10*n*(zi - za)/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))

<span class="fc" id="L2611">                    final var derivativeZa = -derivativeZ1 - derivativeZi;</span>

                    // set derivatives pathLossExponent, x1, y1, z1, xa, ya, za, xi, yi, zi
<span class="fc" id="L2614">                    jacobian.setElementAtIndex(0, derivativePathLossExponent);</span>
<span class="fc" id="L2615">                    jacobian.setElementAtIndex(1, derivativeX1);</span>
<span class="fc" id="L2616">                    jacobian.setElementAtIndex(2, derivativeY1);</span>
<span class="fc" id="L2617">                    jacobian.setElementAtIndex(3, derivativeZ1);</span>
<span class="fc" id="L2618">                    jacobian.setElementAtIndex(4, derivativeXa);</span>
<span class="fc" id="L2619">                    jacobian.setElementAtIndex(5, derivativeYa);</span>
<span class="fc" id="L2620">                    jacobian.setElementAtIndex(6, derivativeZa);</span>
<span class="fc" id="L2621">                    jacobian.setElementAtIndex(7, derivativeXi);</span>
<span class="fc" id="L2622">                    jacobian.setElementAtIndex(8, derivativeYi);</span>
<span class="fc" id="L2623">                    jacobian.setElementAtIndex(9, derivativeZi);</span>


<span class="fc" id="L2626">                    y[0] = derivativePathLossExponent * pathLossExponent;</span>
<span class="fc" id="L2627">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L2631">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L2634">        } catch (final AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L2635">            throw new IndoorException(e);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>